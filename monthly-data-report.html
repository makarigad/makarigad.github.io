<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Monthly Report - Makari Gad Project</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f7fafc; }
        .tab-button { cursor:pointer; padding:0.5rem 1rem; border-bottom:2px solid transparent; }
        .tab-button.active { color:#4f46e5; font-weight:600; border-color:#4f46e5; }
        .table-input { width:100%; padding:0.25rem; border:1px solid #d1d5db; border-radius:0.375rem; font-size:0.875rem; }
        .tight-cell { padding:0.5rem; vertical-align:top; }
        .tight-cell-input { padding:0.25rem; vertical-align:middle; }
        .data-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        th { white-space: normal !important; }
        .w-full { table-layout: fixed; width:100%; word-wrap:break-word; }
        #data-body td, #outages-body td, #mce-body td, #historical-tbody td { font-size: 0.75rem; padding: 4px 3px !important; }
        thead th { padding: 8px 4px !important; }
        .reason-col { width: 500px; }
        .hidden { display:none; }
        .truncate { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #notification-modal { transition: all 0.25s ease; }
    </style>
</head>
<body class="text-gray-800">

    <header class="flex items-center justify-between p-4 bg-white shadow">
        <div>
            <h1 class="text-2xl font-bold">Makari Gad Project</h1>
            <p class="text-sm text-gray-500">Monthly Reports</p>
        </div>
        <div class="flex items-center space-x-3">
            <a href="plant-data.html" class="text-indigo-600 hover:underline">Back to Plant Data</a>
            <div id="user-info" class="text-sm text-indigo-600 font-semibold cursor-pointer" title="Click to logout"></div>
        </div>
    </header>

    <main class="p-4">
        <section id="monthly-report-tab" class="tab-content">
            <div class="data-card">
                <h2 class="text-xl font-semibold mb-2">Monthly Data Report</h2>
                <p class="text-sm text-gray-500 mb-4">Generate and download a consolidated monthly report.</p>
                
                <div class="flex flex-wrap items-end space-x-4 p-4 border rounded-md bg-gray-50">
                    <div>
                        <label for="report-start-year" class="block text-sm font-medium text-gray-700">Start Year (BS)</label>
                        <select id="report-start-year" class="mt-1 table-input"></select>
                    </div>
                    <div>
                        <label for="report-start-month" class="block text-sm font-medium text-gray-700">Start Month (BS)</label>
                        <select id="report-start-month" class="mt-1 table-input"></select>
                    </div>
                    <div>
                        <label for="report-end-year" class="block text-sm font-medium text-gray-700">End Year (BS)</label>
                        <select id="report-end-year" class="mt-1 table-input"></select>
                    </div>
                    <div>
                        <label for="report-end-month" class="block text-sm font-medium text-gray-700">End Month (BS)</label>
                        <select id="report-end-month" class="mt-1 table-input"></select>
                    </div>
                </div>

                <div class="p-4 border rounded-md bg-gray-50 mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select Parameters to Include</p>
                    <div id="report-parameters" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Checkboxes will be dynamically added here -->
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button id="generate-monthly-report-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 text-sm">Download as Excel</button>
                </div>
                <div id="report-status" class="mt-4 text-sm text-gray-600"></div>
            </div>

            <!-- New section to display the report data -->
            <div id="report-output" class="hidden data-card mt-4">
                <h3 class="text-lg font-semibold mb-3">Generated Report Data</h3>
                <div id="report-table-container" class="overflow-x-auto">
                    <!-- The table will be inserted here -->
                </div>
            </div>
        </section>
    </main>

    <div id="notification-modal" class="fixed top-5 right-5 bg-white border-l-4 p-4 rounded-md shadow-lg max-w-sm z-50 opacity-0 transform -translate-y-4 pointer-events-none">
        <p id="notification-message" class="text-sm font-medium"></p>
    </div>

    <div id="confirm-modal-backdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center">
        <div id="confirm-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <h3 id="confirm-title" class="text-lg font-bold text-gray-900">Confirm Action</h3>
            <p id="confirm-message" class="mt-2 text-sm text-gray-600">Are you sure?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        /*************************************************************************
         * Firebase SDK imports
         *************************************************************************/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /*************************************************************************
         * Config
         *************************************************************************/
        const firebaseConfig = { "apiKey": "AIzaSyB9yreNlyZw9DFiuGlwMAecaDkdwn5cxDY", "authDomain": "makari-gad.firebaseapp.com", "projectId": "makari-gad", "storageBucket": "makari-gad.appspot.com", "messagingSenderId": "724611254155", "appId": "1:724611254155:web:79851f67861cee3f90918e" };
        const adminEmail = "upenjyo@gmail.com";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allData = [];
        let allOutages = [];
        let allMCE = [];
        const NEPALI_MONTHS = ["Baisakh", "Jestha", "Ashadh", "Shrawan", "Bhadra", "Asoj", "Kartik", "Mangsir", "Poush", "Magh", "Falgun", "Chaitra"];

        /*************************************************************************
         * Notification and confirm helpers
         *************************************************************************/
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        function showNotification(msg, isError=false) {
            notificationMessage.textContent = msg;
            notificationModal.classList.remove('opacity-0','-translate-y-4');
            notificationModal.style.borderLeftColor = isError ? '#dc2626' : '#10b981';
            notificationModal.classList.add('opacity-100');
            setTimeout(()=> {
                notificationModal.classList.remove('opacity-100');
                notificationModal.classList.add('opacity-0','-translate-y-4');
            },4500);
        }

        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        function showConfirmation(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmModalBackdrop.classList.remove('hidden');
            document.getElementById('confirm-modal').classList.remove('opacity-0','scale-95');
            confirmActionBtn.onclick = () => { onConfirm(); hideConfirmation(); };
        }
        function hideConfirmation() {
            confirmModalBackdrop.classList.add('hidden');
            document.getElementById('confirm-modal').classList.add('opacity-0','scale-95');
        }
        confirmCancelBtn.addEventListener('click', hideConfirmation);
        confirmModalBackdrop.addEventListener('click', (e)=> { if (e.target === confirmModalBackdrop) hideConfirmation(); });

        /*************************************************************************
         * =============== MONTHLY REPORTS logic ======================
         *************************************************************************/
        const reportStartYearSelect = document.getElementById('report-start-year');
        const reportStartMonthSelect = document.getElementById('report-start-month');
        const reportEndYearSelect = document.getElementById('report-end-year');
        const reportEndMonthSelect = document.getElementById('report-end-month');
        const reportParametersContainer = document.getElementById('report-parameters');
        const generateReportBtn = document.getElementById('generate-monthly-report-btn');
        const reportStatus = document.getElementById('report-status');
        const reportOutputDiv = document.getElementById('report-output');
        const reportTableContainer = document.getElementById('report-table-container');
        
        const reportFields = [
            { key: 'energyGenerated', name: 'Energy Generated (MWh)' },
            { key: 'energyDispatched', name: 'Energy Dispatched (MWh)' },
            { key: 'plantFactor', name: 'Plant Factor (%)' },
            { key: 'averagePowerhouseLoad', name: 'Avg. Powerhouse Load (kW)' },
            { key: 'averageSubstationLoad', name: 'Avg. Substation Load (kW)' },
            { key: 'contractEnergy', name: 'Contract Energy (MWh)' },
            { key: 'availabilityDeclaration', name: 'Availability Decl. (MWh)' },
            { key: 'energyDifference', name: 'Energy Difference (MWh)' },
            { key: 'transformerLoss', name: 'Transformer Loss (MWh)' },
            { key: 'stationConsumption', name: 'Station Consumption (MWh)' },
            { key: 'transmissionLoss', name: 'Transmission Loss (MWh)' },
            { key: 'neaCurtailed', name: 'NEA Curtailed (MWh)' },
            { key: 'otherLosses', name: 'Other Losses (MWh)' },
            { key: 'u1RunningHours', name: 'Unit 1 Running Hours' },
            { key: 'u2RunningHours', name: 'Unit 2 Running Hours' },
        ];

        function formatNumber(num, decimals = 2) {
            if (num === null || typeof num === 'undefined' || isNaN(parseFloat(num))) {
                return '';
            }
            const factor = Math.pow(10, decimals);
            return Math.round(num * factor) / factor;
        }

        function initializeMonthlyReportTab() {
            const currentNepaliYear = new Date().getFullYear() + 57; // Approximate BS year
            const years = Array.from({length: 10}, (_, i) => currentNepaliYear - 5 + i);
            const yearOptions = years.map(y => `<option value="${y}">${y}</option>`).join('');
            const monthOptions = NEPALI_MONTHS.map((m, i) => `<option value="${i + 1}">${m}</option>`).join('');

            reportStartYearSelect.innerHTML = yearOptions;
            reportEndYearSelect.innerHTML = yearOptions;
            reportStartMonthSelect.innerHTML = monthOptions;
            reportEndMonthSelect.innerHTML = monthOptions;

            reportFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="report-check-${field.key}" value="${field.key}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 report-checkbox">
                    <label for="report-check-${field.key}" class="ml-2 block text-sm text-gray-900">${field.name}</label>
                `;
                reportParametersContainer.appendChild(div);
            });
        }
        initializeMonthlyReportTab();

        generateReportBtn.addEventListener('click', async () => {
            generateReportBtn.disabled = true;
            generateReportBtn.textContent = 'Generating...';
            reportStatus.textContent = "Generating report...";
            try {
                const reportData = await generateMonthlyReport();
                if (reportData.length > 0) {
                    renderReportTable(reportData);
                    exportToExcel(reportData);
                    reportOutputDiv.classList.remove('hidden');
                    reportStatus.textContent = `Report generated and downloaded successfully.`;
                } else {
                    reportStatus.textContent = "No data found for the selected date range.";
                    reportOutputDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error("Report generation failed:", error);
                reportStatus.textContent = `Report generation failed: ${error.message}`;
                showNotification(`Report generation failed: ${error.message}`, true);
                reportOutputDiv.classList.add('hidden');
            } finally {
                generateReportBtn.disabled = false;
                generateReportBtn.textContent = "Download as Excel";
            }
        });

        async function generateMonthlyReport() {
            const startYear = parseInt(reportStartYearSelect.value);
            const startMonth = parseInt(reportStartMonthSelect.value);
            const endYear = parseInt(reportEndYearSelect.value);
            const endMonth = parseInt(reportEndMonthSelect.value);
            
            if (startYear > endYear || (startYear === endYear && startMonth > endMonth)) {
                throw new Error("Start date must be before or the same as the end date.");
            }
            
            const selectedFields = Array.from(document.querySelectorAll('#report-parameters input:checked')).map(cb => cb.value);
            if (selectedFields.length === 0) {
                throw new Error("Please select at least one parameter to include.");
            }

            const reportData = [];
            let currentYear = startYear;
            let currentMonth = startMonth;

            // Sort data once at the beginning
            allData.sort((a, b) => {
                const [aY, aM, aD] = a.nepali_date.split('.').map(Number);
                const [bY, bM, bD] = b.nepali_date.split('.').map(Number);
                if (aY !== bY) return aY - bY;
                if (aM !== bM) return aM - bM;
                return aD - bD;
            });

            while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
                let nextMonth = currentMonth + 1;
                let nextYear = currentYear;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    nextYear++;
                }

                const monthStartData = allData.find(d => {
                    const [dY, dM, dD] = d.nepali_date.split('.').map(Number);
                    return dY === currentYear && dM === currentMonth && dD === 1;
                });
                
                const nextMonthStartData = allData.find(d => {
                    const [dY, dM, dD] = d.nepali_date.split('.').map(Number);
                    return dY === nextYear && dM === nextMonth && dD === 1;
                });

                if (monthStartData && nextMonthStartData) {
                    const dailyRecordsForMonth = allData.filter(d => {
                        const [dY, dM] = d.nepali_date.split('.').map(Number);
                        return dY === currentYear && dM === currentMonth;
                    });
                    
                    const contractInfo = allMCE.find(c => c.year === currentYear && c.month === currentMonth);
                    const monthlyOutages = allOutages.filter(o => dailyRecordsForMonth.some(d => d.id === o.id));

                    const monthlyReport = calculateMonthlyReport(monthStartData, nextMonthStartData, contractInfo, monthlyOutages, selectedFields, dailyRecordsForMonth.length);
                    reportData.push({
                        'Year (BS)': currentYear,
                        'Month (BS)': NEPALI_MONTHS[currentMonth - 1],
                        ...monthlyReport
                    });
                } else {
                    console.warn(`Missing data for BS year/month: ${currentYear}/${currentMonth}. Skipping.`);
                }
                
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
            }
            return reportData;
        }

        function calculateMonthlyReport(monthStartData, nextMonthStartData, contractInfo, monthlyOutages, selectedFields, daysInMonth) {
            const report = {};
            
            const totalGeneration = (nextMonthStartData.unit1Gen + nextMonthStartData.unit2Gen) - (monthStartData.unit1Gen + monthStartData.unit2Gen);
            const totalExportSubstation = nextMonthStartData.exportSubstation - monthStartData.exportSubstation;
            const totalExportPlant = nextMonthStartData.exportPlant - monthStartData.exportPlant;
            const totalStationConsumption = (nextMonthStartData.stationTrans - monthStartData.stationTrans) / 1000;
            
            if (selectedFields.includes('energyGenerated')) report['Energy Generated (MWh)'] = formatNumber(totalGeneration, 2);
            if (selectedFields.includes('energyDispatched')) report['Energy Dispatched (MWh)'] = formatNumber(totalExportSubstation, 2);

            if (selectedFields.includes('plantFactor')) {
                report['Plant Factor (%)'] = formatNumber((totalExportSubstation / (10 * 24 * daysInMonth)) * 100, 2);
            }
            
            if (selectedFields.includes('averagePowerhouseLoad')) {
                 report['Avg. Powerhouse Load (kW)'] = formatNumber((totalGeneration * 1000) / (24 * daysInMonth), 2);
            }
            if (selectedFields.includes('averageSubstationLoad')) {
                report['Avg. Substation Load (kW)'] = formatNumber((totalExportSubstation * 1000) / (24 * daysInMonth), 2);
            }
            
            if (selectedFields.includes('contractEnergy')) report['Contract Energy (MWh)'] = formatNumber(contractInfo ? contractInfo.contractEnergy : null, 2);
            if (selectedFields.includes('availabilityDeclaration')) report['Availability Decl. (MWh)'] = formatNumber(contractInfo ? contractInfo.totalAD : null, 2);
            if (selectedFields.includes('energyDifference')) {
                report['Energy Difference (MWh)'] = formatNumber(totalExportSubstation - (contractInfo ? contractInfo.totalAD : 0), 2);
            }

            const cumulativeNeaCurtailed = monthlyOutages.reduce((sum, record) => sum + (parseFloat(record.neaCurtailedEnergy) || 0), 0);
            const cumulativeOtherLosses = monthlyOutages.reduce((sum, record) => sum + (parseFloat(record.totalEnergyLoss) || 0), 0);
            const cumulativeTransmissionLoss = totalExportPlant - totalExportSubstation;
            const cumulativeTransformerLoss = totalGeneration - totalExportPlant - totalStationConsumption;
            
            if (selectedFields.includes('transformerLoss')) report['Transformer Loss (MWh)'] = formatNumber(cumulativeTransformerLoss, 2);
            if (selectedFields.includes('stationConsumption')) report['Station Consumption (MWh)'] = formatNumber(totalStationConsumption, 2);
            if (selectedFields.includes('transmissionLoss')) report['Transmission Loss (MWh)'] = formatNumber(cumulativeTransmissionLoss, 2);
            if (selectedFields.includes('neaCurtailed')) report['NEA Curtailed (MWh)'] = formatNumber(cumulativeNeaCurtailed, 2);
            if (selectedFields.includes('otherLosses')) report['Other Losses (MWh)'] = formatNumber(cumulativeOtherLosses, 2);

            const u1RunningHours = (nextMonthStartData.unit1Counter - monthStartData.unit1Counter);
            const u2RunningHours = (nextMonthStartData.unit2Counter - monthStartData.unit2Counter);

            if (selectedFields.includes('u1RunningHours')) report['Unit 1 Running Hours'] = formatNumber(u1RunningHours, 1);
            if (selectedFields.includes('u2RunningHours')) report['Unit 2 Running Hours'] = formatNumber(u2RunningHours, 1);

            return report;
        }

        function renderReportTable(data) {
            const reportFieldMap = reportFields.reduce((map, f) => {
                map[f.key] = f.name;
                return map;
            }, {});
            
            const selectedFields = Object.keys(data[0]).filter(key => key !== 'Year (BS)' && key !== 'Month (BS)');
            const headers = ['Year (BS)', 'Month (BS)', ...selectedFields];
            
            let tableHtml = `<table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>${headers.map(h => `<th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;
            
            data.forEach(row => {
                tableHtml += '<tr>';
                headers.forEach(h => {
                    tableHtml += `<td class="tight-cell text-sm text-gray-500">${row[h] ?? ''}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += `</tbody></table>`;
            reportTableContainer.innerHTML = tableHtml;
        }

        function exportToExcel(data) {
            const reportFieldMap = reportFields.reduce((map, f) => {
                map[f.key] = f.name;
                return map;
            }, {});
            
            const selectedFields = Object.keys(data[0]).filter(key => key !== 'Year (BS)' && key !== 'Month (BS)');
            const headers = ['Year (BS)', 'Month (BS)', ...selectedFields.map(key => reportFieldMap[key])];
            
            const dataToExport = data.map(row => {
                const newRow = {};
                headers.forEach(header => {
                    newRow[header] = row[header];
                });
                return newRow;
            });

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Report");
            XLSX.writeFile(workbook, "MakariGad_MonthlyReport.xlsx");
        }

        async function loadAllData() {
            try {
                const [plantData, monthlyContracts, outages] = await Promise.all([
                    getDocs(query(collection(db, 'plantData'), orderBy('date'))),
                    getDocs(collection(db, 'monthlyContractEnergy')),
                    getDocs(collection(db, 'outagesAndLosses'))
                ]);

                allData = plantData.docs.map(doc => {
                    const data = doc.data();
                    return { id: doc.id, ...data };
                });
                allMCE = monthlyContracts.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allOutages = outages.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                showNotification('Data loaded successfully!');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load data. Please check your connection or permissions.', true);
            }
        }

        /*************************************************************************
         * Auth state and initial startup
         *************************************************************************/
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadAllData();
            } else {
                window.location.href = "index.html";
            }
        });

    </script>
</body>
</html>
