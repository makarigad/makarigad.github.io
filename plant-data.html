<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Data Entry & History</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    form > div {
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px 10px;
    }
    table {
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Makari Gad Hydroelectric Project - Plant Data Entry</h1>
    <p id="user-email" style="color: blue; cursor: pointer;"></p>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="features.html">Features</a>
    <a href="board.html">Board</a>
    <a href="notices.html">Notices</a>
    <a href="contacts.html">Contact</a>
    <a href="plant-data.html">Plant Data</a>
  </nav>

  <main>
    <form id="data-form">
      <div>
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required />
      </div>

      <div><label for="gen1">Generator Unit 1 Reading:</label>
        <input type="number" id="gen1" /></div>

      <div><label for="gen2">Generator Unit 2 Reading:</label>
        <input type="number" id="gen2" /></div>

      <div><label for="gen1hr">Hour Reading Generator Unit 1:</label>
        <input type="number" id="gen1hr" /></div>

      <div><label for="gen2hr">Hour Reading Generator Unit 2:</label>
        <input type="number" id="gen2hr" /></div>

      <div><label for="trans1">Transformer Unit 1 Reading:</label>
        <input type="number" id="trans1" /></div>

      <div><label for="trans2">Transformer Unit 2 Reading:</label>
        <input type="number" id="trans2" /></div>

      <div><label for="station">Station Transformer Reading:</label>
        <input type="number" id="station" /></div>

      <div><label for="feeder">Outgoing Feeder Reading:</label>
        <input type="number" id="feeder" /></div>

      <div><label for="outBalanch">Outgoing Meter @ Balanch:</label>
        <input type="number" id="outBalanch" /></div>

      <div><label for="inBalanch">Incoming Meter @ Balanch:</label>
        <input type="number" id="inBalanch" /></div>

      <button type="submit">Submit</button>
    </form>

    <h2>Last 1 Month Data</h2>
    <table id="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Generator Unit 1</th>
          <th>Generator Unit 2</th>
          <th>Hour Reading Gen 1</th>
          <th>Hour Reading Gen 2</th>
          <th>Transformer Unit 1</th>
          <th>Transformer Unit 2</th>
          <th>Station Transformer</th>
          <th>Outgoing Feeder</th>
          <th>Outgoing @ Balanch</th>
          <th>Incoming @ Balanch</th>
          <th>Entered By</th>
        </tr>
      </thead>
      <tbody id="data-body">
        <!-- Filled dynamically -->
      </tbody>
    </table>
  </main>

  <footer>
    <p>&copy; 2025 Makari Gad Project</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      orderBy,
      Timestamp,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8UJViacRzajLMJ0lonhrbuuEGO54uOJ4",
      authDomain: "makari-c4270.firebaseapp.com",
      projectId: "makari-c4270",
      storageBucket: "makari-c4270.appspot.com",
      messagingSenderId: "188970014713",
      appId: "1:188970014713:web:980629f953af694e81cf28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("data-form");
    const userEmailDisplay = document.getElementById("user-email");
    const dataBody = document.getElementById("data-body");

    let currentUserEmail = null;

    // Helper: format Firestore Timestamp to yyyy-mm-dd
    function formatDate(ts) {
      const d = ts.toDate();
      return d.toISOString().substr(0, 10);
    }

    // Load last 1 month of data and show in table
    async function loadData() {
      dataBody.innerHTML = "";

      const today = new Date();
      const lastMonth = new Date(today);
      lastMonth.setMonth(today.getMonth() - 1);

      // Firestore timestamps are stored as Timestamp
      const q = query(
        collection(db, "plant-data"),
        orderBy("date", "desc")
      );

      const querySnapshot = await getDocs(q);

      // Filter to last month & sort ascending
      let allData = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (data.date && data.date.toDate() >= lastMonth) {
          allData.push({ id: doc.id, ...data });
        }
      });

      allData.sort((a, b) => a.date.toDate() - b.date.toDate());

      for (const entry of allData) {
        const d = formatDate(entry.date);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d}</td>
          <td>${entry.gen1 || ""}</td>
          <td>${entry.gen2 || ""}</td>
          <td>${entry.gen1hr || ""}</td>
          <td>${entry.gen2hr || ""}</td>
          <td>${entry.trans1 || ""}</td>
          <td>${entry.trans2 || ""}</td>
          <td>${entry.station || ""}</td>
          <td>${entry.feeder || ""}</td>
          <td>${entry.outBalanch || ""}</td>
          <td>${entry.inBalanch || ""}</td>
          <td>${entry.email || ""}</td>
        `;
        dataBody.appendChild(row);
      }
    }

    // Set date input to today
    function setToday() {
      const todayStr = new Date().toISOString().substr(0, 10);
      document.getElementById("date").value = todayStr;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please sign in first.");
        window.location.href = "index.html";
        return;
      }
      currentUserEmail = user.email;
      userEmailDisplay.textContent = `Logged in as: ${currentUserEmail}`;
      userEmailDisplay.onclick = async () => {
        await auth.signOut();
        window.location.href = "index.html";
      };

      setToday();
      await loadData();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const dateValue = document.getElementById("date").value;
      if (!dateValue) {
        alert("Please select a date.");
        return;
      }

      // Prepare data object with Timestamp for date
      const data = {
        email: currentUserEmail,
        date: Timestamp.fromDate(new Date(dateValue)),
        gen1: form.gen1.value || "",
        gen2: form.gen2.value || "",
        gen1hr: form.gen1hr.value || "",
        gen2hr: form.gen2hr.value || "",
        trans1: form.trans1.value || "",
        trans2: form.trans2.value || "",
        station: form.station.value || "",
        feeder: form.feeder.value || "",
        outBalanch: form.outBalanch.value || "",
        inBalanch: form.inBalanch.value || "",
      };

      try {
        await addDoc(collection(db, "plant-data"), data);
        alert("Data saved successfully!");
        form.reset();
        setToday();
        await loadData();
      } catch (err) {
        alert("Error saving data: " + err.message);
      }
    });
  </script>
</body>
</html>
