<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plant Data Entry</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Plant Data Entry</h1>
    <div id="user-info" style="float: right; cursor: pointer; color: blue;"></div>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="features.html">Features</a>
    <a href="board.html">Board</a>
    <a href="notices.html">Notices</a>
    <a href="contacts.html">Contact</a>
    <a href="plant-data.html">Plant Data</a>
  </nav>

  <main>
    <h3>Daily Metering Form</h3>
    <form id="dataForm">
      <label>Date: <input type="date" id="date" value="2025-07-26"></label><br>

      <label>Generator Unit 1 (MWh): <input type="number" step="0.01" id="gen1" required></label><br>
      <label>Hour Reading GU1 (hr): <input type="number" step="0.01" id="hour1"></label><br>

      <label>Generator Unit 2 (MWh): <input type="number" step="0.01" id="gen2"></label><br>
      <label>Hour Reading GU2 (hr): <input type="number" step="0.01" id="hour2"></label><br>

      <label>Transformer Unit 1 (MWh): <input type="number" step="0.01" id="trans1"></label><br>
      <label>Transformer Unit 2 (MWh): <input type="number" step="0.01" id="trans2"></label><br>

      <label>Station Transformer (MWh): <input type="number" step="0.01" id="station"></label><br>
      <label>Outgoing Feeder (MWh): <input type="number" step="0.01" id="feeder"></label><br>
      <label>Outgoing Meter (MWh): <input type="number" step="0.01" id="outgoing"></label><br>
      <label>Incoming Meter (MWh): <input type="number" step="0.01" id="incoming"></label><br>

      <button type="submit">Submit</button>
    </form>

    <h3>Last 1 Month's Data</h3>
    <table border="1" id="dataTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Operator</th>
          <th>GU1 (MWh)</th>
          <th>GU2 (MWh)</th>
          <th>HR1</th>
          <th>HR2</th>
          <th>TU1</th>
          <th>TU2</th>
          <th>ST</th>
          <th>Feeder</th>
          <th>Outgoing</th>
          <th>Incoming</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA8UJViacRzajLMJ0lonhrbuuEGO54uOJ4",
      authDomain: "makari-c4270.firebaseapp.com",
      projectId: "makari-c4270",
      storageBucket: "makari-c4270.appspot.com",
      messagingSenderId: "188970014713",
      appId: "1:188970014713:web:980629f953af694e81cf28"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const userInfo = document.getElementById("user-info");
    let currentUser = null;

    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        userInfo.textContent = user.email;
        userInfo.onclick = () => {
          auth.signOut().then(() => window.location.href = "index.html");
        };
        loadData();
      } else {
        alert("Not signed in");
        window.location.href = "index.html";
      }
    });

    document.getElementById("dataForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const doc = {
        date: document.getElementById("date").value,
        gen1: parseFloat(document.getElementById("gen1").value),
        hour1: parseFloat(document.getElementById("hour1").value) || 0,
        gen2: parseFloat(document.getElementById("gen2").value) || 0,
        hour2: parseFloat(document.getElementById("hour2").value) || 0,
        trans1: parseFloat(document.getElementById("trans1").value) || 0,
        trans2: parseFloat(document.getElementById("trans2").value) || 0,
        station: parseFloat(document.getElementById("station").value) || 0,
        feeder: parseFloat(document.getElementById("feeder").value) || 0,
        outgoing: parseFloat(document.getElementById("outgoing").value) || 0,
        incoming: parseFloat(document.getElementById("incoming").value) || 0,
        user: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection("plantData").add(doc).then(() => {
        alert("Data saved");
        loadData();
        document.getElementById("dataForm").reset();
      });
    });

    function loadData() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      const oneMonthAgo = new Date();
      oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);

      db.collection("plantData")
        .where("timestamp", ">=", oneMonthAgo)
        .orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const d = doc.data();
            const row = `
              <tr>
                <td>${d.date}</td>
                <td>${d.user}</td>
                <td>${d.gen1}</td>
                <td>${d.gen2}</td>
                <td>${d.hour1}</td>
                <td>${d.hour2}</td>
                <td>${d.trans1}</td>
                <td>${d.trans2}</td>
                <td>${d.station}</td>
                <td>${d.feeder}</td>
                <td>${d.outgoing}</td>
                <td>${d.incoming}</td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        });
    }
  </script>
</body>
</html>
