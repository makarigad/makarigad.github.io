<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plant Data - Makari Gad Project (Merged Tabs)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f7fafc; }
    .tab-button { cursor:pointer; padding:0.5rem 1rem; border-bottom:2px solid transparent; }
    .tab-button.active { color:#4f46e5; font-weight:600; border-color:#4f46e5; }
    .table-input { width:100%; padding:0.25rem; border:1px solid #d1d5db; border-radius:0.375rem; font-size:0.875rem; }
    .tight-cell { padding:0.5rem; vertical-align:top; }
    .tight-cell-input { padding:0.25rem; vertical-align:middle; }
    /* Keep your original table width sizing rules */
    th { white-space: normal !important; }
    .w-full { table-layout: fixed; width:100%; word-wrap:break-word; }
    #data-body td, #outages-body td { font-size: 0.75rem; padding: 4px 3px !important; }
    thead th { padding: 8px 4px !important; }
  </style>
</head>
<body class="text-gray-800">

  <header class="flex items-center justify-between p-4 bg-white shadow">
    <div>
      <h1 class="text-2xl font-bold">Makari Gad Project</h1>
      <p class="text-sm text-gray-500">Metering & Contract Energy</p>
    </div>
    <div class="flex items-center space-x-3">
      <div id="user-info" class="text-sm text-indigo-600 font-semibold cursor-pointer" title="Click to logout"></div>
    </div>
  </header>

  <div class="flex gap-4 p-4 bg-gray-50 border-b">
    <div class="tab-button active" data-target="daily-tab">Daily Metering</div>
    <div class="tab-button" data-target="outages-tab">Outages & Losses</div>
    <div class="tab-button" data-target="monthly-tab">Monthly Contract Energy</div>
  </div>

  <main class="p-4">

    <section id="daily-tab" class="tab-content">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="text-xl font-semibold">Plant Daily Meter Readings</h2>
          <p class="text-sm text-gray-500">Makari Gad Project | <a href="index.html" class="text-indigo-600 hover:underline">Home</a></p>
        </div>
        <div class="flex items-center space-x-2">
          <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 text-sm hidden">Download as Excel</button>
          <button id="upload-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 text-sm hidden">Upload</button>
          <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" title="Upload Excel, CSV, or XLS file" />
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
        <h3 class="text-lg font-semibold mb-3">Historical Data</h3>
        <table class="w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English Date</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nepali Date</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Gen</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Gen</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Trans</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Trans</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Station Trans</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Export Plant</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Export Substation</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Import Outgoing</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Import Substation</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Counter</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Counter</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operator</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="data-body" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
      </div>
    </section>

    <section id="outages-tab" class="tab-content hidden">
       <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="text-xl font-semibold">Outages & Losses Log</h2>
           <p class="text-sm text-gray-500">Record and track all plant and grid-related outages.</p>
        </div>
        <div class="flex items-center space-x-2">
          <button id="outages-download-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 text-sm hidden">Download Excel</button>
          <button id="outages-upload-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 text-sm hidden">Upload Excel</button>
          <input type="file" id="outages-file-upload" class="hidden" accept=".xlsx, .xls, .csv" />
        </div>
      </div>
       <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
         <h3 class="text-lg font-semibold mb-3">Event History</h3>
         <table class="w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
             <tr>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Event Start</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Event End</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Type</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Component</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Reason</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Duration (Hrs)</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Energy Loss (kWh)</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Operator</th>
               <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
             </tr>
           </thead>
           <tbody id="outages-body" class="bg-white divide-y divide-gray-200">
             </tbody>
         </table>
       </div>
    </section>

    <section id="monthly-tab" class="tab-content hidden">
      <div class="bg-white p-4 rounded-lg shadow-md mb-4">
        <div class="flex flex-wrap gap-3 items-center">
          <h3 class="text-lg font-semibold mr-4">Monthly Contract Energy</h3>

          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Year</label>
            <select id="mce-year" class="border rounded px-2 py-1" title="Year"></select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Month</label>
            <select id="mce-month" class="border rounded px-2 py-1" title="Month">
              <option value="">All</option>
              <option value="Baisakh">Baisakh</option><option value="Jestha">Jestha</option><option value="Ashadh">Ashadh</option>
              <option value="Shrawan">Shrawan</option><option value="Bhadra">Bhadra</option><option value="Asoj">Asoj</option>
              <option value="Kartik">Kartik</option><option value="Mangsir">Mangsir</option><option value="Poush">Poush</option>
              <option value="Magh">Magh</option><option value="Falgun">Falgun</option><option value="Chaitra">Chaitra</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">From</label>
            <select id="range-from-year" class="border rounded px-2 py-1" title="From Year"></select>
            <select id="range-from-month" class="border rounded px-2 py-1" title="From Month">
              <option value="">--</option>
              <option value="Baisakh">Baisakh</option><option value="Jestha">Jestha</option><option value="Ashadh">Ashadh</option>
              <option value="Shrawan">Shrawan</option><option value="Bhadra">Bhadra</option><option value="Asoj">Asoj</option>
              <option value="Kartik">Kartik</option><option value="Mangsir">Mangsir</option><option value="Poush">Poush</option>
              <option value="Magh">Magh</option><option value="Falgun">Falgun</option><option value="Chaitra">Chaitra</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">To</label>
            <select id="range-to-year" class="border rounded px-2 py-1" title="To Year"></select>
            <select id="range-to-month" class="border rounded px-2 py-1">
              <option value="">--</option>
              <option value="Baisakh">Baisakh</option><option value="Jestha">Jestha</option><option value="Ashadh">Ashadh</option>
              <option value="Shrawan">Shrawan</option><option value="Bhadra">Bhadra</option><option value="Asoj">Asoj</option>
              <option value="Kartik">Kartik</option><option value="Mangsir">Mangsir</option><option value="Poush">Poush</option>
              <option value="Magh">Magh</option><option value="Falgun">Falgun</option><option value="Chaitra">Chaitra</option>
            </select>
          </div>

          <div class="ml-auto flex items-center gap-2">
            <button id="mce-download-all" class="bg-green-600 text-white px-3 py-1 rounded hidden">Download All</button>
            <button id="mce-download-range" class="bg-indigo-600 text-white px-3 py-1 rounded hidden">Download Range</button>
            <button id="mce-upload-btn-monthly" class="bg-blue-600 text-white px-3 py-1 rounded hidden">Upload Excel</button>
            <input id="mce-file" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
          </div>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
        <table class="w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Year</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Month</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Week1 AD (kWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Week2 AD (kWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Week3 AD (kWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Week4 AD (kWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Week5 AD (kWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Total AD (MWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">Contract Energy (MWh)</th>
              <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase">No. of Days</th>
            </tr>
          </thead>
          <tbody id="mce-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>

  </main>

  <div id="notification-modal" class="fixed top-5 right-5 bg-white border-l-4 p-4 rounded-md shadow-lg max-w-sm z-50 opacity-0 transform -translate-y-4 pointer-events-none">
    <p id="notification-message" class="text-sm font-medium"></p>
  </div>

  <div id="confirm-modal-backdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center">
    <div id="confirm-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
      <h3 id="confirm-title" class="text-lg font-bold text-gray-900">Confirm Action</h3>
      <p id="confirm-message" class="mt-2 text-sm text-gray-600">Are you sure?</p>
      <div class="mt-6 flex justify-end space-x-3">
        <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
        <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
      </div>
    </div>
  </div>

  <script type="module">
    /*************************************************************************
     * Firebase SDK imports (same versions as your original file)
     *************************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc, writeBatch, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /*************************************************************************
     * Config (kept identical to your original snippet)
     *************************************************************************/
    const firebaseConfig = { "apiKey": "AIzaSyB9yreNlyZw9DFiuGlwMAecaDkdwn5cxDY", "authDomain": "makari-gad.firebaseapp.com", "projectId": "makari-gad", "storageBucket": "makari-gad.appspot.com", "messagingSenderId": "724611254155", "appId": "1:724611254155:web:79851f67861cee3f90918e" };
    const adminEmail = "upenjyo@gmail.com";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /*************************************************************************
     * Tab switching behaviour
     *************************************************************************/
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        const target = btn.dataset.target;
        document.getElementById(target).classList.remove('hidden');
      });
    });

    /*************************************************************************
     * Notification and confirm helpers (reused from your original file)
     *************************************************************************/
    const notificationModal = document.getElementById('notification-modal');
    const notificationMessage = document.getElementById('notification-message');
    function showNotification(msg, isError=false) {
      notificationMessage.textContent = msg;
      notificationModal.classList.remove('opacity-0','-translate-y-4');
      notificationModal.style.borderLeftColor = isError ? '#dc2626' : '#10b981';
      notificationModal.classList.add('opacity-100');
      setTimeout(()=> {
        notificationModal.classList.remove('opacity-100');
        notificationModal.classList.add('opacity-0','-translate-y-4');
      },4500);
    }

    const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

    function showConfirmation(title, message, onConfirm) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      confirmModalBackdrop.classList.remove('hidden');
      document.getElementById('confirm-modal').classList.remove('opacity-0','scale-95');
      confirmActionBtn.onclick = () => { onConfirm(); hideConfirmation(); };
    }
    function hideConfirmation() {
      confirmModalBackdrop.classList.add('hidden');
      document.getElementById('confirm-modal').classList.add('opacity-0','scale-95');
    }
    confirmCancelBtn.addEventListener('click', hideConfirmation);
    confirmModalBackdrop.addEventListener('click', (e)=> { if (e.target === confirmModalBackdrop) hideConfirmation(); });

    /*************************************************************************
     * =============== DAILY METERING logic (unchanged) ======================
     *************************************************************************/
    const plantDataPath = "plantData";
    let currentUser = null;
    let unsubscribe = null;
    let allData = [];
    let editingRowId = null;

    const userInfo = document.getElementById("user-info");
    const dataBody = document.getElementById("data-body");
    const downloadBtn = document.getElementById("download-btn");
    const uploadBtn = document.getElementById("upload-btn");
    const fileUpload = document.getElementById("file-upload");

    function formatNumber(num) {
      if (num === null || typeof num === 'undefined' || isNaN(parseFloat(num))) {
        return '';
      }
      return Math.round(num * 1000) / 1000;
    }

    function createInputRow() {
      const today = new Date();
      const offset = today.getTimezoneOffset();
      const localToday = new Date(today.getTime() - (offset * 60 * 1000));
      const dateString = localToday.toISOString().split('T')[0];

      return `
        <tr id="add-new-row" class="bg-indigo-50">
            <td class="tight-cell-input"><input type="date" id="new-date" class="table-input" value="${dateString}" required /></td>
            <td class="tight-cell-input"><input type="text" id="new-nepali_date" class="table-input" placeholder="YYYY-MM-DD" /></td>
            <td class="tight-cell-input"><input type="number" id="new-unit1Gen" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-unit2Gen" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-unit1Trans" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-unit2Trans" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-stationTrans" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-exportPlant" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-exportSubstation" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-importOutgoing" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-importSubstation" step="any" class="table-input" /></td>
            <td class="tight-cell-input"></td>
            <td class="tight-cell-input"><input type="number" id="new-unit1Counter" step="any" class="table-input" /></td>
            <td class="tight-cell-input"><input type="number" id="new-unit2Counter" step="any" class="table-input" /></td>
            <td class="tight-cell text-sm truncate" title="${currentUser ? currentUser.email : ''}">${currentUser ? currentUser.email : ''}</td>
            <td class="tight-cell-input">
                <button id="add-entry-btn" class="w-full bg-indigo-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Add</button>
            </td>
        </tr>
      `;
    }

    function createDisplayRowHtml(d) {
      const canEdit = currentUser && (currentUser.uid === d.uid || currentUser.email === adminEmail);
      const docDataString = JSON.stringify(d).replace(/'/g, "&apos;");
      return `
        <td class="tight-cell text-sm font-medium text-gray-900">${d.id}</td>
        <td class="tight-cell text-sm text-gray-500">${d.nepali_date || ''}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Gen)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Gen)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Trans)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Trans)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.stationTrans)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.exportPlant)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.exportSubstation)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.importOutgoing)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.importSubstation)}</td>
        <td class="tight-cell text-sm text-gray-500"></td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Counter)}</td>
        <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Counter)}</td>
        <td class="tight-cell text-sm text-gray-500 truncate" title="${d.user}">${d.user}</td>
        <td class="tight-cell text-sm font-medium space-x-2 whitespace-nowrap">
            ${canEdit ? `<button class="edit-btn text-indigo-600 hover:text-indigo-900" data-doc='${docDataString}'>Edit</button><button class="delete-btn text-red-600 hover:text-red-900" data-id="${d.id}">Delete</button>` : ''}
        </td>`;
    }

    function createEditRowHtml(docData) {
      return `
        <td class="tight-cell-input"><input type="date" class="table-input" value="${docData.id}" disabled /></td>
        <td class="tight-cell-input"><input type="text" id="edit-nepali_date" class="table-input" value="${docData.nepali_date || ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit1Gen" step="any" class="table-input" value="${docData.unit1Gen ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit2Gen" step="any" class="table-input" value="${docData.unit2Gen ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit1Trans" step="any" class="table-input" value="${docData.unit1Trans ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit2Trans" step="any" class="table-input" value="${docData.unit2Trans ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-stationTrans" step="any" class="table-input" value="${docData.stationTrans ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-exportPlant" step="any" class="table-input" value="${docData.exportPlant ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-exportSubstation" step="any" class="table-input" value="${docData.exportSubstation ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-importOutgoing" step="any" class="table-input" value="${docData.importOutgoing ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-importSubstation" step="any" class="table-input" value="${docData.importSubstation ?? ''}" /></td>
        <td class="tight-cell-input"></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit1Counter" step="any" class="table-input" value="${docData.unit1Counter ?? ''}" /></td>
        <td class="tight-cell-input"><input type="number" id="edit-unit2Counter" step="any" class="table-input" value="${docData.unit2Counter ?? ''}" /></td>
        <td class="tight-cell text-sm truncate" title="${currentUser ? currentUser.email : ''}">${currentUser ? currentUser.email : ''}</td>
        <td class="tight-cell flex space-x-2 whitespace-nowrap">
            <button class="update-btn bg-green-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-700" data-id="${docData.id}">Update</button>
            <button class="cancel-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-md hover:bg-gray-300">Cancel</button>
        </td>
      `;
    }

    function renderTable(data) {
      dataBody.innerHTML = createInputRow();
      data.forEach(d => {
        const row = document.createElement('tr');
        row.id = `row-${d.id}`;
        row.innerHTML = (d.id === editingRowId) ? createEditRowHtml(d) : createDisplayRowHtml(d);
        dataBody.appendChild(row);
      });
    }

    async function handleAddOrUpdateEntry(docId, isUpdate = false) {
      if (!currentUser) { showNotification("You must be logged in.", true); return; }

      const prefix = isUpdate ? 'edit-' : 'new-';
      const dateVal = isUpdate ? docId : document.getElementById(`${prefix}date`).value;
      if (!dateVal) { showNotification("Please select an English date.", true); return; }

      const data = {
        user: currentUser.email,
        uid: currentUser.uid,
        date: Timestamp.fromDate(new Date(dateVal)),
        nepali_date: document.getElementById(`${prefix}nepali_date`).value || null,
        unit1Gen: parseFloat(document.getElementById(`${prefix}unit1Gen`).value) || null,
        unit2Gen: parseFloat(document.getElementById(`${prefix}unit2Gen`).value) || null,
        unit1Trans: parseFloat(document.getElementById(`${prefix}unit1Trans`).value) || null,
        unit2Trans: parseFloat(document.getElementById(`${prefix}unit2Trans`).value) || null,
        stationTrans: parseFloat(document.getElementById(`${prefix}stationTrans`).value) || null,
        exportPlant: parseFloat(document.getElementById(`${prefix}exportPlant`).value) || null,
        exportSubstation: parseFloat(document.getElementById(`${prefix}exportSubstation`).value) || null,
        importOutgoing: parseFloat(document.getElementById(`${prefix}importOutgoing`).value) || null,
        importSubstation: parseFloat(document.getElementById(`${prefix}importSubstation`).value) || null,
        unit1Counter: parseFloat(document.getElementById(`${prefix}unit1Counter`).value) || null,
        unit2Counter: parseFloat(document.getElementById(`${prefix}unit2Counter`).value) || null,
      };

      try {
        await setDoc(doc(db, plantDataPath, dateVal), data, { merge: true });
        showNotification(`Data ${isUpdate ? 'updated' : 'added'} successfully!`);
        if (isUpdate) {
          editingRowId = null;
          renderTable(allData);
        } else {
          // Clear only the new entry row after successful submission
          const addRow = document.getElementById('add-new-row');
          if (addRow) addRow.querySelectorAll('input').forEach(input => { if (input.type !== 'date') input.value = ''; });
        }
      } catch (error) {
        console.error("Error saving data:", error);
        showNotification("Error saving data: " + (error.message || error), true);
      }
    }

    dataBody.addEventListener('click', e => {
      if (e.target.id === 'add-entry-btn') handleAddOrUpdateEntry(null, false);
      if (e.target.classList.contains('edit-btn')) {
        editingRowId = JSON.parse(e.target.dataset.doc).id;
        renderTable(allData);
      }
      if (e.target.classList.contains('delete-btn')) {
        showDeleteConfirm(e.target.dataset.id);
      }
      if (e.target.classList.contains('update-btn')) handleAddOrUpdateEntry(e.target.dataset.id, true);
      if (e.target.classList.contains('cancel-btn')) {
        editingRowId = null;
        renderTable(allData);
      }
    });

    function showDeleteConfirm(docId) {
      showConfirmation('Confirm Deletion', `Are you sure you want to delete the entry for ${docId}? This cannot be undone.`, () => deleteEntry(docId));
    }

    async function deleteEntry(docId) {
      try {
        await deleteDoc(doc(db, plantDataPath, docId));
        showNotification("Entry deleted successfully.");
      } catch (error) {
        console.error("Error deleting document:", error);
        showNotification("Error deleting entry: " + (error.message || error), true);
      }
    }

    downloadBtn.addEventListener('click', () => {
      const dataToExport = allData.map(d => ({
        'English Date': d.id,
        'Nepali Date': d.nepali_date,
        'Unit 1 Generator Reading': d.unit1Gen,
        'Unit 2 Generator Reading': d.unit2Gen,
        'Unit 1 Transformer Reading': d.unit1Trans,
        'Unit 2 Transformer Reading': d.unit2Trans,
        'Station Transformer Reading': d.stationTrans,
        'Export at Plant Outgoing Feeder': d.exportPlant,
        'Export at Substation Feeder': d.exportSubstation,
        'Import at Outgoing Feeder': d.importOutgoing,
        'Import at Substation Feeder': d.importSubstation,
        '': null, // Blank column
        'Unit 1 hour counter': d.unit1Counter,
        'Unit 2 hour counter': d.unit2Counter,
        'Operator': d.user
      }));
      const worksheet = XLSX.utils.json_to_sheet(dataToExport, {header: [
        "English Date", "Nepali Date", "Unit 1 Generator Reading", "Unit 2 Generator Reading",
        "Unit 1 Transformer Reading", "Unit 2 Transformer Reading", "Station Transformer Reading",
        "Export at Plant Outgoing Feeder", "Export at Substation Feeder", "Import at Outgoing Feeder",
        "Import at Substation Feeder", "", "Unit 1 hour counter", "Unit 2 hour counter", "Operator"
      ]});
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "PlantData");
      XLSX.writeFile(workbook, "PlantData_MakariGad.xlsx");
      showNotification("Downloading Excel file...");
    });

    uploadBtn.addEventListener('click', () => fileUpload.click());
    fileUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });

          if (jsonData.length < 2) {
            return showNotification("File is empty or has no data rows.", true);
          }
          showConfirmation('Confirm Upload', `This will upload ${jsonData.length - 1} records. Existing data for the same dates will be overwritten. Continue?`, () => processAndUploadData(jsonData));
        } catch (error) {
          console.error("File read error:", error);
          showNotification("Error reading file. Please ensure it's a valid Excel file.", true);
        }
      };
      reader.readAsArrayBuffer(file);
      fileUpload.value = '';
    });

    async function processAndUploadData(jsonData) {
      if (!currentUser) { return showNotification("Authentication error. Please re-login.", true); }
      showNotification("Starting upload...", false);

      const header = jsonData.shift().map(h => String(h ?? "").trim());
      const headerMap = {
        englishDate: header.indexOf('English Date'),
        nepaliDate: header.indexOf('Nepali Date'),
        unit1Gen: header.indexOf('Unit 1 Generator Reading'),
        unit2Gen: header.indexOf('Unit 2 Generator Reading'),
        unit1Trans: header.indexOf('Unit 1 Transformer Reading'),
        unit2Trans: header.indexOf('Unit 2 Transformer Reading'),
        stationTrans: header.indexOf('Station Transformer Reading'),
        exportPlant: header.indexOf('Export at Plant Outgoing Feeder'),
        exportSubstation: header.indexOf('Export at Substation Feeder'),
        importOutgoing: header.indexOf('Import at Outgoing Feeder'),
        importSubstation: header.indexOf('Import at Substation Feeder'),
        unit1Counter: header.indexOf('Unit 1 hour counter'),
        unit2Counter: header.indexOf('Unit 2 hour counter'),
      };

      if (headerMap.englishDate === -1) { return showNotification("Upload failed. 'English Date' column not found.", true); }

      const batch = writeBatch(db);
      let operationsCount = 0;
      jsonData.forEach(row => {
        const dateValue = row[headerMap.englishDate];
        if (!dateValue || !(dateValue instanceof Date)) return;

        const localDate = new Date(dateValue.getTime() - (dateValue.getTimezoneOffset() * 60000));
        const dateStr = localDate.toISOString().split('T')[0];

        const docRef = doc(db, plantDataPath, dateStr);
        const docData = {
          user: currentUser.email, uid: currentUser.uid,
          date: Timestamp.fromDate(localDate),
          nepali_date: row[headerMap.nepaliDate] || null,
          unit1Gen: parseFloat(row[headerMap.unit1Gen]) || null,
          unit2Gen: parseFloat(row[headerMap.unit2Gen]) || null,
          unit1Trans: parseFloat(row[headerMap.unit1Trans]) || null,
          unit2Trans: parseFloat(row[headerMap.unit2Trans]) || null,
          stationTrans: parseFloat(row[headerMap.stationTrans]) || null,
          exportPlant: parseFloat(row[headerMap.exportPlant]) || null,
          exportSubstation: parseFloat(row[headerMap.exportSubstation]) || null,
          importOutgoing: parseFloat(row[headerMap.importOutgoing]) || null,
          importSubstation: parseFloat(row[headerMap.importSubstation]) || null,
          unit1Counter: parseFloat(row[headerMap.unit1Counter]) || null,
          unit2Counter: parseFloat(row[headerMap.unit2Counter]) || null,
        };
        batch.set(docRef, docData, { merge: true });
        operationsCount++;
      });

      if (operationsCount === 0) { return showNotification("No valid data rows found to upload.", true); }

      try {
        await batch.commit();
        showNotification(`Successfully uploaded ${operationsCount} records.`, false);
      } catch (error) {
        console.error("Batch upload error:", error);
        showNotification("Upload failed: " + (error.message || error), true);
      }
    }

    function loadAndListenData() {
      if (unsubscribe) unsubscribe();
      const dataCollection = collection(db, plantDataPath);
      const q = query(dataCollection);
      unsubscribe = onSnapshot(q, (querySnapshot) => {
        const rows = [];
        querySnapshot.forEach((docSnap) => rows.push({ id: docSnap.id, ...docSnap.data() }));
        rows.sort((a, b) => b.id.localeCompare(a.id));
        allData = rows;
        renderTable(allData);
      }, (error) => {
        console.error("Error fetching data:", error);
        showNotification("Error fetching data.", true);
      });
    }

    /*************************************************************************
     * =============== OUTAGES & LOSSES logic (NEW) ==========================
     *************************************************************************/
    const outagesDataPath = "outagesAndLosses";
    const outagesBody = document.getElementById("outages-body");
    const outagesDownloadBtn = document.getElementById('outages-download-btn');
    const outagesUploadBtn = document.getElementById('outages-upload-btn');
    const outagesFileUpload = document.getElementById('outages-file-upload');
    
    let allOutages = [];
    let editingOutageId = null;

    // Helper to format Firestore Timestamps to a string for datetime-local input
    function formatTimestampForInput(timestamp) {
        if (!timestamp || !timestamp.toDate) return '';
        const date = timestamp.toDate();
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        return localDate.toISOString().slice(0, 16);
    }
    
    // Helper to calculate duration in hours
    function calculateDuration(start, end) {
        if (!start || !end || !start.toDate || !end.toDate) return '';
        const durationMs = end.toDate().getTime() - start.toDate().getTime();
        if (durationMs < 0) return 'Invalid';
        return (durationMs / (1000 * 60 * 60)).toFixed(2);
    }
    
    // Create new outage entry row
    function createOutageInputRow() {
        return `
            <tr id="add-new-outage-row" class="bg-indigo-50">
                <td class="tight-cell-input"><input type="datetime-local" id="new-outage-start" class="table-input" required /></td>
                <td class="tight-cell-input"><input type="datetime-local" id="new-outage-end" class="table-input" /></td>
                <td class="tight-cell-input">
                    <select id="new-outage-type" class="table-input">
                        <option value="Forced">Forced</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="Grid Failure">Grid Failure</option>
                        <option value="Line Loss">Line Loss</option>
                    </select>
                </td>
                <td class="tight-cell-input">
                     <select id="new-outage-component" class="table-input">
                        <option value="Unit 1">Unit 1</option>
                        <option value="Unit 2">Unit 2</option>
                        <option value="Transmission Line">Transmission Line</option>
                        <option value="Station Transformer">Station Transformer</option>
                    </select>
                </td>
                <td class="tight-cell-input"><input type="text" id="new-outage-reason" class="table-input" /></td>
                <td class="tight-cell text-sm text-gray-500"></td> <td class="tight-cell-input"><input type="number" id="new-outage-loss" step="any" class="table-input" placeholder="kWh" /></td>
                <td class="tight-cell text-sm truncate" title="${currentUser?.email || ''}">${currentUser?.email || ''}</td>
                <td class="tight-cell-input">
                    <button id="add-outage-btn" class="w-full bg-indigo-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Add</button>
                </td>
            </tr>
        `;
    }

    // Create outage display row
    function createOutageDisplayRow(d) {
        const canEdit = currentUser && (currentUser.uid === d.uid || currentUser.email === adminEmail);
        const docDataString = JSON.stringify(d).replace(/'/g, "&apos;");
        return `
            <td class="tight-cell text-sm font-medium text-gray-900">${formatTimestampForInput(d.eventStart)}</td>
            <td class="tight-cell text-sm text-gray-500">${formatTimestampForInput(d.eventEnd)}</td>
            <td class="tight-cell text-sm text-gray-500">${d.eventType || ''}</td>
            <td class="tight-cell text-sm text-gray-500">${d.component || ''}</td>
            <td class="tight-cell text-sm text-gray-500">${d.reason || ''}</td>
            <td class="tight-cell text-sm text-gray-500">${calculateDuration(d.eventStart, d.eventEnd)}</td>
            <td class="tight-cell text-sm text-gray-500">${d.energyLossKWH || ''}</td>
            <td class="tight-cell text-sm text-gray-500 truncate" title="${d.user}">${d.user}</td>
            <td class="tight-cell text-sm font-medium space-x-2 whitespace-nowrap">
                ${canEdit ? `<button class="edit-outage-btn text-indigo-600 hover:text-indigo-900" data-doc='${docDataString}'>Edit</button><button class="delete-outage-btn text-red-600 hover:text-red-900" data-id="${d.id}">Delete</button>` : ''}
            </td>
        `;
    }

    // Create outage edit row
    function createOutageEditRow(d) {
      return `
        <td class="tight-cell-input"><input type="datetime-local" id="edit-outage-start" class="table-input" value="${formatTimestampForInput(d.eventStart)}" /></td>
        <td class="tight-cell-input"><input type="datetime-local" id="edit-outage-end" class="table-input" value="${formatTimestampForInput(d.eventEnd)}" /></td>
        <td class="tight-cell-input">
            <select id="edit-outage-type" class="table-input">
                <option value="Forced" ${d.eventType === 'Forced' ? 'selected' : ''}>Forced</option>
                <option value="Scheduled" ${d.eventType === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                <option value="Grid Failure" ${d.eventType === 'Grid Failure' ? 'selected' : ''}>Grid Failure</option>
                <option value="Line Loss" ${d.eventType === 'Line Loss' ? 'selected' : ''}>Line Loss</option>
            </select>
        </td>
        <td class="tight-cell-input">
            <select id="edit-outage-component" class="table-input">
                <option value="Unit 1" ${d.component === 'Unit 1' ? 'selected' : ''}>Unit 1</option>
                <option value="Unit 2" ${d.component === 'Unit 2' ? 'selected' : ''}>Unit 2</option>
                <option value="Transmission Line" ${d.component === 'Transmission Line' ? 'selected' : ''}>Transmission Line</option>
                <option value="Station Transformer" ${d.component === 'Station Transformer' ? 'selected' : ''}>Station Transformer</option>
            </select>
        </td>
        <td class="tight-cell-input"><input type="text" id="edit-outage-reason" class="table-input" value="${d.reason || ''}" /></td>
        <td></td> <td class="tight-cell-input"><input type="number" id="edit-outage-loss" step="any" class="table-input" value="${d.energyLossKWH || ''}" /></td>
        <td class="tight-cell text-sm truncate" title="${currentUser?.email || ''}">${currentUser?.email || ''}</td>
        <td class="tight-cell flex space-x-2 whitespace-nowrap">
            <button class="update-outage-btn bg-green-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-700" data-id="${d.id}">Update</button>
            <button class="cancel-outage-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-md hover:bg-gray-300">Cancel</button>
        </td>
      `;
    }
    
    // Render the outages table
    function renderOutagesTable() {
        outagesBody.innerHTML = createOutageInputRow();
        allOutages.forEach(d => {
            const row = document.createElement('tr');
            row.id = `outage-row-${d.id}`;
            row.innerHTML = (d.id === editingOutageId) ? createOutageEditRow(d) : createOutageDisplayRow(d);
            outagesBody.appendChild(row);
        });
    }

    // Load and listen for outage data
    function loadOutagesData() {
        const q = query(collection(db, outagesDataPath), orderBy("eventStart", "desc"));
        onSnapshot(q, (snapshot) => {
            allOutages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderOutagesTable();
        }, (error) => {
            console.error("Error fetching outages:", error);
            showNotification("Could not load outage data.", true);
        });
    }

    // Add or Update an outage entry
    async function handleAddOrUpdateOutage(docId, isUpdate = false) {
        if (!currentUser) return showNotification("You must be logged in.", true);

        const prefix = isUpdate ? 'edit-' : 'new-';
        const startVal = document.getElementById(`${prefix}-outage-start`).value;
        const endVal = document.getElementById(`${prefix}-outage-end`).value;

        if (!startVal) return showNotification("Event Start time is required.", true);

        const data = {
            user: currentUser.email,
            uid: currentUser.uid,
            eventStart: Timestamp.fromDate(new Date(startVal)),
            eventEnd: endVal ? Timestamp.fromDate(new Date(endVal)) : null,
            eventType: document.getElementById(`${prefix}-outage-type`).value,
            component: document.getElementById(`${prefix}-outage-component`).value,
            reason: document.getElementById(`${prefix}-outage-reason`).value || null,
            energyLossKWH: parseFloat(document.getElementById(`${prefix}-outage-loss`).value) || null,
            updatedAt: Timestamp.now(),
        };

        try {
            const docRef = isUpdate ? doc(db, outagesDataPath, docId) : doc(collection(db, outagesDataPath));
            if (!isUpdate) data.createdAt = Timestamp.now();
            await setDoc(docRef, data, { merge: true });
            showNotification(`Outage record ${isUpdate ? 'updated' : 'added'} successfully!`);
            if (isUpdate) {
                editingOutageId = null;
            }
            renderOutagesTable(); // This will re-render and clear the input row implicitly
        } catch (error) {
            console.error("Error saving outage:", error);
            showNotification("Error saving outage data: " + error.message, true);
        }
    }

    // Event delegation for the outages table
    outagesBody.addEventListener('click', async (e) => {
        if (e.target.id === 'add-outage-btn') handleAddOrUpdateOutage(null, false);
        if (e.target.classList.contains('edit-outage-btn')) {
            editingOutageId = JSON.parse(e.target.dataset.doc).id;
            renderOutagesTable();
        }
        if (e.target.classList.contains('update-outage-btn')) {
            handleAddOrUpdateOutage(e.target.dataset.id, true);
        }
        if (e.target.classList.contains('cancel-outage-btn')) {
            editingOutageId = null;
            renderOutagesTable();
        }
        if (e.target.classList.contains('delete-outage-btn')) {
            const docId = e.target.dataset.id;
            showConfirmation('Confirm Deletion', `Are you sure you want to delete this outage record? This cannot be undone.`, async () => {
                try {
                    await deleteDoc(doc(db, outagesDataPath, docId));
                    showNotification("Outage record deleted.");
                } catch (error) {
                    showNotification("Error deleting record: " + error.message, true);
                }
            });
        }
    });

    // Download outages data as Excel
    outagesDownloadBtn.addEventListener('click', () => {
        const dataToExport = allOutages.map(d => ({
            "Event Start": formatTimestampForInput(d.eventStart),
            "Event End": formatTimestampForInput(d.eventEnd),
            "Type": d.eventType,
            "Component": d.component,
            "Reason": d.reason,
            "Duration (Hours)": calculateDuration(d.eventStart, d.eventEnd),
            "Energy Loss (kWh)": d.energyLossKWH,
            "Operator": d.user,
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "OutagesAndLosses");
        XLSX.writeFile(workbook, "OutagesAndLosses_MakariGad.xlsx");
        showNotification("Downloading Outages Excel file...");
    });
    
    // Upload outages data from Excel
    outagesUploadBtn.addEventListener('click', () => outagesFileUpload.click());
    outagesFileUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) return showNotification("File is empty.", true);
                showConfirmation('Confirm Upload', `This will upload ${jsonData.length} outage records. Continue?`, () => processAndUploadOutages(jsonData));
            } catch (error) {
                showNotification("Error reading file. Make sure it's a valid Excel format.", true);
            }
        };
        reader.readAsArrayBuffer(file);
        outagesFileUpload.value = '';
    });

    async function processAndUploadOutages(jsonData) {
        if (!currentUser) return showNotification("Authentication error.", true);
        showNotification("Starting upload of outage data...");
        const batch = writeBatch(db);
        let count = 0;

        jsonData.forEach(row => {
            const start = row['Event Start'];
            if (!start || !(start instanceof Date)) return; // Skip rows without a valid start date

            const docRef = doc(collection(db, outagesDataPath));
            const docData = {
                eventStart: Timestamp.fromDate(start),
                eventEnd: (row['Event End'] && row['Event End'] instanceof Date) ? Timestamp.fromDate(row['Event End']) : null,
                eventType: row['Type'] || null,
                component: row['Component'] || null,
                reason: row['Reason'] || null,
                energyLossKWH: parseFloat(row['Energy Loss (kWh)']) || null,
                user: currentUser.email,
                uid: currentUser.uid,
                createdAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            };
            batch.set(docRef, docData);
            count++;
        });

        if (count === 0) return showNotification("No valid outage records found in the file.", true);

        try {
            await batch.commit();
            showNotification(`Successfully uploaded ${count} outage records.`);
        } catch (error) {
            showNotification("Upload failed: " + error.message, true);
        }
    }


    /*************************************************************************
     * =============== MONTHLY CONTRACT ENERGY (MCE) logic ===================
     *************************************************************************/
    const mceYear = document.getElementById('mce-year');
    const mceMonth = document.getElementById('mce-month');
    const mceBody = document.getElementById('mce-body');

    const rangeFromYear = document.getElementById('range-from-year');
    const rangeToYear = document.getElementById('range-to-year');
    const rangeFromMonth = document.getElementById('range-from-month');
    const rangeToMonth = document.getElementById('range-to-month');

    const mceUploadBtn = document.getElementById('mce-upload-btn-monthly');
    const mceFileInput = document.getElementById('mce-file');
    const mceDownloadAllBtn = document.getElementById('mce-download-all');
    const mceDownloadRangeBtn = document.getElementById('mce-download-range');

    const nepaliMonthsMap = {
        "Baisakh": 1, "Jestha": 2, "Ashar": 3, "Shrawan": 4, "Bhadra": 5, "Ashoj": 6,
        "Kartik": 7, "Mangshir": 8, "Poush": 9, "Magh": 10, "Falgun": 11, "Chaitra": 12
    };

    function getMonthSortOrder(monthValue) {
        if (typeof monthValue === 'number') return monthValue;
        if (typeof monthValue === 'string') {
            const num = parseInt(monthValue, 10);
            if (!isNaN(num) && num > 0 && num <= 12) return num;
            return nepaliMonthsMap[monthValue] || 0;
        }
        return 0;
    }

    function populateYearOptions(start = 2079, end = 2085) {
      const make = (el) => {
        el.innerHTML = '<option value="">All</option>';
        for (let y = start; y <= end; y++) {
          const opt = document.createElement('option'); opt.value = y; opt.textContent = y;
          el.appendChild(opt);
        }
      };
      make(mceYear);
      rangeFromYear.innerHTML = '<option value="">Year</option>';
      rangeToYear.innerHTML = '<option value="">Year</option>';
      for (let y = start; y <= end; y++) {
        const o1 = document.createElement('option'); o1.value = y; o1.textContent = y; rangeFromYear.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = y; o2.textContent = y; rangeToYear.appendChild(o2);
      }
    }
    populateYearOptions(2079, 2085);

    let allMCE = [];

    function formatValue(value, decimals = 2) {
        if (value === null || typeof value === 'undefined' || isNaN(Number(value))) {
            return '';
        }
        return Number(value).toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: decimals,
        });
    }

    function formatKwhToMwh(kwhValue) {
        if (kwhValue === null || typeof kwhValue === 'undefined' || isNaN(Number(kwhValue))) {
            return '';
        }
        const mwh = Number(kwhValue) / 1;
        return formatValue(mwh, 2);
    }

    function loadMCEData() {
      const q = query(collection(db, "monthlyContractEnergy"));
      onSnapshot(q, (snap) => {
        allMCE = snap.docs.map(d => d.data());
        allMCE.forEach(r => {
          r.year = r.year ?? null;
          r.month = r.month ?? null;
        });
        renderMCE();
      }, (error) => {
        console.error("MCE load error:", error);
        showNotification("Error loading monthly contract energy data", true);
      });
    }

    function renderMCE() {
      const y = mceYear.value;
      const m = mceMonth.value;
      let filtered = [...allMCE];

      if (y) filtered = filtered.filter(r => String(r.year) === String(y));
      if (m) filtered = filtered.filter(r => r.month === m);

      filtered.sort((a, b) => {
        const yearA = a.year || 0;
        const yearB = b.year || 0;
        if (yearA !== yearB) {
            return yearB - yearA;
        }
        return getMonthSortOrder(b.month) - getMonthSortOrder(a.month);
      });

      mceBody.innerHTML = '';
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="tight-cell text-sm">${r.year ?? ''}</td>
          <td class="tight-cell text-sm">${r.month ?? ''}</td>
          <td class="tight-cell text-sm">${formatValue(r.week1AD)}</td>
          <td class="tight-cell text-sm">${formatValue(r.week2AD)}</td>
          <td class="tight-cell text-sm">${formatValue(r.week3AD)}</td>
          <td class="tight-cell text-sm">${formatValue(r.week4AD)}</td>
          <td class="tight-cell text-sm">${formatValue(r.week5AD)}</td>
          <td class="tight-cell text-sm font-medium">${formatKwhToMwh(r.totalAD)}</td>
          <td class="tight-cell text-sm">${formatKwhToMwh(r.contractEnergy)}</td>
          <td class="tight-cell text-sm">${r.noOfDays ?? ''}</td>
        `;
        mceBody.appendChild(tr);
      });
    }

    mceYear.addEventListener('change', renderMCE);
    mceMonth.addEventListener('change', renderMCE);
    
    mceUploadBtn.addEventListener('click', () => mceFileInput.click());
    mceFileInput.addEventListener('change', (evt) => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
          if (!rows || rows.length === 0) {
            showNotification("Uploaded file has no rows", true); return;
          }
          showConfirmation('Confirm Upload', `This will upload ${rows.length} records to monthlyContractEnergy. Continue?`, () => uploadMCE(rows));
        } catch (err) {
          console.error(err);
          showNotification("Error reading Excel file", true);
        }
      };
      reader.readAsArrayBuffer(file);
      mceFileInput.value = '';
    });

    async function uploadMCE(rows) {
      if (!currentUser) { showNotification("Not authenticated", true); return; }
      const batch = writeBatch(db);
      let count = 0;

      rows.forEach(r => {
        const getVal = (possibleNames) => {
          for (const name of possibleNames) {
            if (r.hasOwnProperty(name)) return r[name];
          }
          for (const k of Object.keys(r)) {
            if (possibleNames.map(x=>x.toLowerCase()).includes(k.toLowerCase().replace(/\s+/g,''))) return r[k];
            if (possibleNames.some(p => k.toLowerCase().replace(/\s+/g,'').includes(p.toLowerCase().replace(/\s+/g,'')))) return r[k];
          }
          return null;
        };

        const year = getVal(['Year','year','YEAR']);
        const month = getVal(['Month','month','MONTH']);
        if (!year || !month) return;

        const week1AD = getVal(['Week1_AD','Week 1 AD','Week1AD','Week1']);
        const week2AD = getVal(['Week2_AD','Week 2 AD','Week2AD','Week2']);
        const week3AD = getVal(['Week3_AD','Week 3 AD','Week3AD','Week3']);
        const week4AD = getVal(['Week4_AD','Week 4 AD','Week4AD','Week4']);
        const week5AD = getVal(['Week5_AD','Week 5 AD','Week5AD','Week5']);
        const totalAD = getVal(['Total_AD','Total AD','TotalAD','Total']);
        const contractEnergy = getVal(['Contract_Energy','Contract Energy','ContractEnergy','Contract']);
        const noOfDays = getVal(['No_of_Days','No of Days','NoOfDays','Days']);

        const docId = `${String(year).trim()}_${String(month).trim()}`;
        const docRef = doc(db, "monthlyContractEnergy", docId);

        const docData = {
          year: isNaN(Number(year)) ? year : Number(year),
          month: String(month).trim(),
          week1AD: (week1AD === null || week1AD === '') ? null : Number(week1AD),
          week2AD: (week2AD === null || week2AD === '') ? null : Number(week2AD),
          week3AD: (week3AD === null || week3AD === '') ? null : Number(week3AD),
          week4AD: (week4AD === null || week4AD === '') ? null : Number(week4AD),
          week5AD: (week5AD === null || week5AD === '') ? null : Number(week5AD),
          totalAD: (totalAD === null || totalAD === '') ? null : Number(totalAD),
          contractEnergy: (contractEnergy === null || contractEnergy === '') ? null : Number(contractEnergy),
          noOfDays: (noOfDays === null || noOfDays === '') ? null : Number(noOfDays),
          uploadedBy: currentUser.email,
          uploadedAt: Timestamp.fromDate(new Date())
        };
        batch.set(docRef, docData, { merge: true });
        count++;
      });

      if (count === 0) { showNotification("No valid MCE rows found to upload.", true); return; }

      try {
        await batch.commit();
        showNotification(`Uploaded ${count} MCE records successfully.`, false);
      } catch (err) {
        console.error(err);
        showNotification("Error uploading MCE: " + (err.message || err), true);
      }
    }

    mceDownloadAllBtn.addEventListener('click', () => {
      if (!allMCE || allMCE.length === 0) { showNotification("No MCE data to download", true); return; }
      const dataOut = allMCE.map(r => ({
        Year: r.year,
        Month: r.month,
        Week1_AD: r.week1AD,
        Week2_AD: r.week2AD,
        Week3_AD: r.week3AD,
        Week4_AD: r.week4AD,
        Week5_AD: r.week5AD,
        Total_AD: r.totalAD,
        Contract_Energy: r.contractEnergy,
        No_of_Days: r.noOfDays
      }));
      const ws = XLSX.utils.json_to_sheet(dataOut);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "MonthlyContractEnergy");
      XLSX.writeFile(wb, "MonthlyContractEnergy_All.xlsx");
      showNotification("Downloading all Monthly Contract Energy data...");
    });

    mceDownloadRangeBtn.addEventListener('click', () => {
      const fy = rangeFromYear.value;
      const fm = rangeFromMonth.value;
      const ty = rangeToYear.value;
      const tm = rangeToMonth.value;

      if (!fy || !fm || !ty || !tm) {
        showNotification("Please select full From and To Year & Month for range download.", true);
        return;
      }

      function comp(aYear, aMonth, bYear, bMonth) {
        if (Number(aYear) === Number(bYear)) return (nepaliMonthsMap[aMonth] || 0) - (nepaliMonthsMap[bMonth] || 0);
        return Number(aYear) - Number(bYear);
      }

      const selected = allMCE.filter(r => {
        if (!r.year || !r.month) return false;
        const c1 = comp(r.year, r.month, fy, fm);
        const c2 = comp(r.year, r.month, ty, tm);
        return c1 >= 0 && c2 <= 0;
      });

      if (selected.length === 0) { showNotification("No records found in the selected range.", true); return; }

      const dataOut = selected.map(r => ({
        Year: r.year,
        Month: r.month,
        Week1_AD: r.week1AD,
        Week2_AD: r.week2AD,
        Week3_AD: r.week3AD,
        Week4_AD: r.week4AD,
        Week5_AD: r.week5AD,
        Total_AD: r.totalAD,
        Contract_Energy: r.contractEnergy,
        No_of_Days: r.noOfDays
      }));
      const ws = XLSX.utils.json_to_sheet(dataOut);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "MCE_Range");
      XLSX.writeFile(wb, `MCE_${fy}_${fm}_to_${ty}_${tm}.xlsx`);
      showNotification("Downloading selected range...");
    });

    /*************************************************************************
     * Auth state and initial startup
     *************************************************************************/
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        userInfo.textContent = `Logged in as: ${user.email}`;
        userInfo.onclick = () => showConfirmation('Confirm Logout', 'Are you sure you want to log out?', () => signOut(auth));

        if (currentUser.email === adminEmail) {
          downloadBtn.classList.remove('hidden');
          uploadBtn.classList.remove('hidden');
          mceUploadBtn.classList.remove('hidden');
          mceDownloadAllBtn.classList.remove('hidden');
          mceDownloadRangeBtn.classList.remove('hidden');
          // Show new outage buttons for admin
          outagesDownloadBtn.classList.remove('hidden');
          outagesUploadBtn.classList.remove('hidden');
        }

        loadAndListenData();
        loadMCEData();
        loadOutagesData(); // <-- Initialize the new outages tab data
      } else {
        const currentPath = window.location.pathname;
        const newPath = currentPath.substring(0, currentPath.lastIndexOf('/')) + '/index.html';
        window.location.href = newPath;
      }
    });

  </script>
</body>
</html>