<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Data - Makari Gad Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .table-input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            font-size: 0.875rem;
            min-width: 65px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .table-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.5);
            outline: none;
        }
        #notification-modal, #confirm-modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #confirm-modal {
             transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .tight-cell {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            vertical-align: top;
        }
        .tight-cell-input {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            vertical-align: middle;
        }
        th {
            white-space: normal !important;
        }
        .w-full {
            table-layout: fixed;
            width: 100%;
            word-wrap: break-word;
        }
        #data-body td {
            font-size: 0.75rem;
            padding: 4px 3px !important;
        }
        thead th {
            padding: 8px 4px !important;
        }
        
        /* Column widths re-distributed */
        thead th:nth-child(1) { width: 8%; }  /* English Date */
        thead th:nth-child(2) { width: 8%; }  /* Nepali Date */
        thead th:nth-child(3) { width: 6%; } /* Unit 1 Gen */
        thead th:nth-child(4) { width: 6%; } /* Unit 2 Gen */
        thead th:nth-child(5) { width: 6%; } /* Unit 1 Trans */
        thead th:nth-child(6) { width: 6%; } /* Unit 2 Trans */
        thead th:nth-child(7) { width: 6%; }  /* SST */
        thead th:nth-child(8) { width: 7%; } /* Export Plant */
        thead th:nth-child(9) { width: 7%; } /* Export Substation */
        thead th:nth-child(10){ width: 7%; } /* Import Outgoing */
        thead th:nth-child(11){ width: 7%; } /* Import Substation */
        thead th:nth-child(12){ width: 1%; } /* Blank */
        thead th:nth-child(13){ width: 6%; }  /* Unit 1 counter */
        thead th:nth-child(14){ width: 6%; }  /* Unit 2 counter */
        thead th:nth-child(15){ width: 6%; } /* Operator */
        thead th:nth-child(16){ width: 8%; }  /* Actions */
        
        .table-input {
            min-width: unset;
            padding: 2px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="text-gray-800">
<div id="header-placeholder"></div>
    <div id="notification-modal" class="fixed top-5 right-5 bg-white border-l-4 p-4 rounded-md shadow-lg max-w-sm z-50 opacity-0 transform translate-y-[-20px] pointer-events-none">
        <p id="notification-message" class="text-sm font-medium"></p>
    </div>

    <div id="confirm-modal-backdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center">
        <div id="confirm-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <h3 id="confirm-title" class="text-lg font-bold text-gray-900">Confirm Action</h3>
            <p id="confirm-message" class="mt-2 text-sm text-gray-600">Are you sure?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <div class="p-2 sm:p-4 lg:p-6 w-full">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b border-gray-200">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Plant Daily Meter Readings</h1>
                <p class="text-sm text-gray-500 mt-1">Makari Gad Project | <a href="index.html" class="text-indigo-600 hover:underline">Home</a></p>
            </div>
            <div class="flex items-center space-x-2 mt-3 sm:mt-0">
                 <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 text-sm hidden">Download as Excel</button>
                 <button id="upload-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 text-sm hidden">Upload</button>
                 <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" title="Upload Excel or CSV file" placeholder="Select file to upload" />
                 <div id="user-info" class="text-right text-sm text-indigo-600 font-semibold cursor-pointer hover:text-indigo-800" title="Click to logout"></div>
            </div>
        </header>

        <main>
            <section>
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Historical Data</h2>
                    <div>
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English Date</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nepali Date</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Gen</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Gen</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Trans</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Trans</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Station Trans</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Export Plant</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Export Substation</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Import Outgoing</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Import Substation</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 1 Counter</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit 2 Counter</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operator</th>
                                    <th class="tight-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { "apiKey": "AIzaSyB9yreNlyZw9DFiuGlwMAecaDkdwn5cxDY", "authDomain": "makari-gad.firebaseapp.com", "projectId": "makari-gad", "storageBucket": "makari-gad.appspot.com", "messagingSenderId": "724611254155", "appId": "1:724611254155:web:79851f67861cee3f90918e" };
        const adminEmail = "upenjyo@gmail.com";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const plantDataPath = "plantData";
        let currentUser = null;
        let unsubscribe = null;
        let allData = [];
        let editingRowId = null;

        const userInfo = document.getElementById("user-info"), dataBody = document.getElementById("data-body");
        const downloadBtn = document.getElementById("download-btn"), uploadBtn = document.getElementById("upload-btn"), fileUpload = document.getElementById("file-upload");
        const confirmModalBackdrop = document.getElementById("confirm-modal-backdrop"), confirmTitle = document.getElementById("confirm-title"), confirmMessage = document.getElementById("confirm-message"), confirmCancelBtn = document.getElementById("confirm-cancel-btn"), confirmActionBtn = document.getElementById("confirm-action-btn");

        function showNotification(message, isError = false) {
            const modal = document.getElementById('notification-modal');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            modal.className = modal.className.replace(/border-(green|red)-500/, '');
            modal.classList.add(isError ? 'border-red-500' : 'border-green-500');
            modal.classList.remove('opacity-0', 'translate-y-[-20px]');
            modal.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                modal.classList.remove('opacity-100', 'translate-y-0');
                modal.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 5000);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userInfo.textContent = `Logged in as: ${user.email}`;
                userInfo.onclick = () => showConfirmation('Confirm Logout', 'Are you sure you want to log out?', () => signOut(auth));
                
                if (currentUser.email === adminEmail) {
                    downloadBtn.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                }
                loadAndListenData();
            } else {
                const currentPath = window.location.pathname;
                const newPath = currentPath.substring(0, currentPath.lastIndexOf('/')) + '/index.html';
                window.location.href = newPath;
            }
        });

        function loadAndListenData() {
            if (unsubscribe) unsubscribe();
            const dataCollection = collection(db, plantDataPath);
            const q = query(dataCollection);
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const rows = [];
                querySnapshot.forEach((docSnap) => rows.push({ id: docSnap.id, ...docSnap.data() }));
                rows.sort((a, b) => b.id.localeCompare(a.id));
                allData = rows;
                renderTable(allData);
            }, (error) => {
                console.error("Error fetching data:", error);
                showNotification("Error fetching data.", true);
            });
        }
        
        function createInputRow() {
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const localToday = new Date(today.getTime() - (offset * 60 * 1000));
            const dateString = localToday.toISOString().split('T')[0];

            return `
                <tr id="add-new-row" class="bg-indigo-50">
                    <td class="tight-cell-input"><input type="date" id="new-date" class="table-input" value="${dateString}" required /></td>
                    <td class="tight-cell-input"><input type="text" id="new-nepali_date" class="table-input" placeholder="YYYY-MM-DD" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit1Gen" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit2Gen" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit1Trans" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit2Trans" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-stationTrans" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-exportPlant" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-exportSubstation" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-importOutgoing" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-importSubstation" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit1Counter" step="any" class="table-input" /></td>
                    <td class="tight-cell-input"><input type="number" id="new-unit2Counter" step="any" class="table-input" /></td>
                    <td class="tight-cell text-sm truncate" title="${currentUser.email}">${currentUser.email}</td>
                    <td class="tight-cell-input">
                        <button id="add-entry-btn" class="w-full bg-indigo-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Add</button>
                    </td>
                </tr>
            `;
        }

        function formatNumber(num) {
            if (num === null || typeof num === 'undefined' || isNaN(parseFloat(num))) {
                return '';
            }
            return Math.round(num * 1000) / 1000;
        }

        function renderTable(data) {
            dataBody.innerHTML = createInputRow();
            data.forEach(d => {
                const row = document.createElement('tr');
                row.id = `row-${d.id}`;
                row.innerHTML = (d.id === editingRowId) ? createEditRowHtml(d) : createDisplayRowHtml(d);
                dataBody.appendChild(row);
            });
        }
        
        function createDisplayRowHtml(d) {
            const canEdit = currentUser && (currentUser.uid === d.uid || currentUser.email === adminEmail);
            const docDataString = JSON.stringify(d).replace(/'/g, "&apos;");
            return `
                <td class="tight-cell text-sm font-medium text-gray-900">${d.id}</td>
                <td class="tight-cell text-sm text-gray-500">${d.nepali_date || ''}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Gen)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Gen)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Trans)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Trans)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.stationTrans)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.exportPlant)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.exportSubstation)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.importOutgoing)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.importSubstation)}</td>
                <td class="tight-cell text-sm text-gray-500"></td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit1Counter)}</td>
                <td class="tight-cell text-sm text-gray-500">${formatNumber(d.unit2Counter)}</td>
                <td class="tight-cell text-sm text-gray-500 truncate" title="${d.user}">${d.user}</td>
                <td class="tight-cell text-sm font-medium space-x-2 whitespace-nowrap">
                    ${canEdit ? `<button class="edit-btn text-indigo-600 hover:text-indigo-900" data-doc='${docDataString}'>Edit</button><button class="delete-btn text-red-600 hover:text-red-900" data-id="${d.id}">Delete</button>` : ''}
                </td>`;
        }

        function createEditRowHtml(docData) {
            return `
                <td class="tight-cell-input"><input type="date" class="table-input" value="${docData.id}" disabled /></td>
                <td class="tight-cell-input"><input type="text" id="edit-nepali_date" class="table-input" value="${docData.nepali_date || ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit1Gen" step="any" class="table-input" value="${docData.unit1Gen ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit2Gen" step="any" class="table-input" value="${docData.unit2Gen ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit1Trans" step="any" class="table-input" value="${docData.unit1Trans ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit2Trans" step="any" class="table-input" value="${docData.unit2Trans ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-stationTrans" step="any" class="table-input" value="${docData.stationTrans ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-exportPlant" step="any" class="table-input" value="${docData.exportPlant ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-exportSubstation" step="any" class="table-input" value="${docData.exportSubstation ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-importOutgoing" step="any" class="table-input" value="${docData.importOutgoing ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-importSubstation" step="any" class="table-input" value="${docData.importSubstation ?? ''}" /></td>
                <td class="tight-cell-input"></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit1Counter" step="any" class="table-input" value="${docData.unit1Counter ?? ''}" /></td>
                <td class="tight-cell-input"><input type="number" id="edit-unit2Counter" step="any" class="table-input" value="${docData.unit2Counter ?? ''}" /></td>
                <td class="tight-cell text-sm truncate" title="${currentUser.email}">${currentUser.email}</td>
                <td class="tight-cell flex space-x-2 whitespace-nowrap">
                    <button class="update-btn bg-green-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-700" data-id="${docData.id}">Update</button>
                    <button class="cancel-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-md hover:bg-gray-300">Cancel</button>
                </td>
            `;
        }
        
        // =================================================================================
        // === THIS IS THE CORRECTED FUNCTION ===
        // =================================================================================
        async function handleAddOrUpdateEntry(docId, isUpdate = false) {
            if (!currentUser) { showNotification("You must be logged in.", true); return; }

            const prefix = isUpdate ? 'edit-' : 'new-';
            const dateVal = isUpdate ? docId : document.getElementById(`${prefix}date`).value;
            if (!dateVal) { showNotification("Please select an English date.", true); return; }

            // CORRECTED: This block now correctly reads from the table row inputs.
            const data = {
                user: currentUser.email,
                uid: currentUser.uid,
                date: Timestamp.fromDate(new Date(dateVal)),
                nepali_date: document.getElementById(`${prefix}nepali_date`).value || null,
                unit1Gen: parseFloat(document.getElementById(`${prefix}unit1Gen`).value) || null,
                unit2Gen: parseFloat(document.getElementById(`${prefix}unit2Gen`).value) || null,
                unit1Trans: parseFloat(document.getElementById(`${prefix}unit1Trans`).value) || null,
                unit2Trans: parseFloat(document.getElementById(`${prefix}unit2Trans`).value) || null,
                stationTrans: parseFloat(document.getElementById(`${prefix}stationTrans`).value) || null,
                exportPlant: parseFloat(document.getElementById(`${prefix}exportPlant`).value) || null,
                exportSubstation: parseFloat(document.getElementById(`${prefix}exportSubstation`).value) || null,
                importOutgoing: parseFloat(document.getElementById(`${prefix}importOutgoing`).value) || null,
                importSubstation: parseFloat(document.getElementById(`${prefix}importSubstation`).value) || null,
                unit1Counter: parseFloat(document.getElementById(`${prefix}unit1Counter`).value) || null,
                unit2Counter: parseFloat(document.getElementById(`${prefix}unit2Counter`).value) || null,
            };

            try {
                await setDoc(doc(db, plantDataPath, dateVal), data, { merge: true });
                showNotification(`Data ${isUpdate ? 'updated' : 'added'} successfully!`);
                if (isUpdate) {
                    editingRowId = null;
                    renderTable(allData);
                } else {
                    // Clear only the new entry row after successful submission
                    document.getElementById('add-new-row').querySelectorAll('input').forEach(input => {
                        if(input.type !== 'date') input.value = '';
                    });
                }
            } catch (error) {
                console.error("Error saving data:", error);
                showNotification("Error saving data: " + error.message, true);
            }
        }

        dataBody.addEventListener('click', e => {
            if (e.target.id === 'add-entry-btn') handleAddOrUpdateEntry(null, false);
            if (e.target.classList.contains('edit-btn')) {
                editingRowId = JSON.parse(e.target.dataset.doc).id;
                renderTable(allData);
            }
            if (e.target.classList.contains('delete-btn')) {
                showDeleteConfirm(e.target.dataset.id);
            }
            if (e.target.classList.contains('update-btn')) handleAddOrUpdateEntry(e.target.dataset.id, true);
            if (e.target.classList.contains('cancel-btn')) {
                editingRowId = null;
                renderTable(allData);
            }
        });

        function showConfirmation(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmModalBackdrop.classList.remove('hidden');
            document.getElementById('confirm-modal').classList.remove('opacity-0', 'scale-95');
            confirmActionBtn.onclick = () => {
                onConfirm();
                hideConfirmation();
            };
        }

        function hideConfirmation() {
            confirmModalBackdrop.classList.add('hidden');
            document.getElementById('confirm-modal').classList.add('opacity-0', 'scale-95');
        }

        confirmCancelBtn.addEventListener('click', hideConfirmation);
        confirmModalBackdrop.addEventListener('click', (e) => { if (e.target === confirmModalBackdrop) hideConfirmation(); });

        function showDeleteConfirm(docId) {
            showConfirmation('Confirm Deletion', `Are you sure you want to delete the entry for ${docId}? This cannot be undone.`, () => deleteEntry(docId));
        }

        async function deleteEntry(docId) {
            try {
                await deleteDoc(doc(db, plantDataPath, docId));
                showNotification("Entry deleted successfully.");
            } catch (error) {
                console.error("Error deleting document:", error);
                showNotification("Error deleting entry: " + error.message, true);
            }
        }

        // --- Excel Download/Upload Logic ---
        downloadBtn.addEventListener('click', () => {
            const dataToExport = allData.map(d => ({
                'English Date': d.id,
                'Nepali Date': d.nepali_date,
                'Unit 1 Generator Reading': d.unit1Gen,
                'Unit 2 Generator Reading': d.unit2Gen,
                'Unit 1 Transformer Reading': d.unit1Trans,
                'Unit 2 Transformer Reading': d.unit2Trans,
                'Station Transformer Reading': d.stationTrans,
                'Export at Plant Outgoing Feeder': d.exportPlant,
                'Export at Substation Feeder': d.exportSubstation,
                'Import at Outgoing Feeder': d.importOutgoing,
                'Import at Substation Feeder': d.importSubstation,
                '': null, // Blank column
                'Unit 1 hour counter': d.unit1Counter,
                'Unit 2 hour counter': d.unit2Counter,
                'Operator': d.user
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport, {header: [
                "English Date", "Nepali Date", "Unit 1 Generator Reading", "Unit 2 Generator Reading", 
                "Unit 1 Transformer Reading", "Unit 2 Transformer Reading", "Station Transformer Reading",
                "Export at Plant Outgoing Feeder", "Export at Substation Feeder", "Import at Outgoing Feeder",
                "Import at Substation Feeder", "", "Unit 1 hour counter", "Unit 2 hour counter", "Operator"
            ]});
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "PlantData");
            XLSX.writeFile(workbook, "PlantData_MakariGad.xlsx");
            showNotification("Downloading Excel file...");
        });

        uploadBtn.addEventListener('click', () => fileUpload.click());
        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });
                    
                    if (jsonData.length < 2) {
                        return showNotification("File is empty or has no data rows.", true);
                    }
                    showConfirmation('Confirm Upload', `This will upload ${jsonData.length - 1} records. Existing data for the same dates will be overwritten. Continue?`, () => processAndUploadData(jsonData));
                } catch (error) {
                    console.error("File read error:", error);
                    showNotification("Error reading file. Please ensure it's a valid Excel file.", true);
                }
            };
            reader.readAsArrayBuffer(file);
            fileUpload.value = '';
        });

        // =================================================================================
        // === THIS IS THE CORRECTED FUNCTION ===
        // =================================================================================
        async function processAndUploadData(jsonData) {
            if (!currentUser) { return showNotification("Authentication error. Please re-login.", true); }
            showNotification("Starting upload...", false);

            const header = jsonData.shift().map(h => String(h ?? "").trim());
            
            // CORRECTED: The keys now exactly match the headers from your Excel screenshot.
            const headerMap = {
                englishDate: header.indexOf('English Date'),
                nepaliDate: header.indexOf('Nepali Date'),
                unit1Gen: header.indexOf('Unit 1 Generator Reading'),
                unit2Gen: header.indexOf('Unit 2 Generator Reading'),
                unit1Trans: header.indexOf('Unit 1 Transformer Reading'),
                unit2Trans: header.indexOf('Unit 2 Transformer Reading'),
                stationTrans: header.indexOf('Station Transformer Reading'),
                exportPlant: header.indexOf('Export at Plant Outgoing Feeder'),
                exportSubstation: header.indexOf('Export at Substation Feeder'),
                importOutgoing: header.indexOf('Import at Outgoing Feeder'),
                importSubstation: header.indexOf('Import at Substation Feeder'),
                unit1Counter: header.indexOf('Unit 1 hour counter'),
                unit2Counter: header.indexOf('Unit 2 hour counter'),
            };

            if (headerMap.englishDate === -1) { return showNotification("Upload failed. 'English Date' column not found.", true); }

            const batch = writeBatch(db);
            let operationsCount = 0;
            jsonData.forEach(row => {
                const dateValue = row[headerMap.englishDate];
                if (!dateValue || !(dateValue instanceof Date)) return;

                const localDate = new Date(dateValue.getTime() - (dateValue.getTimezoneOffset() * 60000));
                const dateStr = localDate.toISOString().split('T')[0];

                const docRef = doc(db, plantDataPath, dateStr);
                const docData = {
                    user: currentUser.email, uid: currentUser.uid,
                    date: Timestamp.fromDate(localDate),
                    nepali_date: row[headerMap.nepaliDate] || null,
                    unit1Gen: parseFloat(row[headerMap.unit1Gen]) || null,
                    unit2Gen: parseFloat(row[headerMap.unit2Gen]) || null,
                    unit1Trans: parseFloat(row[headerMap.unit1Trans]) || null,
                    unit2Trans: parseFloat(row[headerMap.unit2Trans]) || null,
                    stationTrans: parseFloat(row[headerMap.stationTrans]) || null,
                    exportPlant: parseFloat(row[headerMap.exportPlant]) || null,
                    exportSubstation: parseFloat(row[headerMap.exportSubstation]) || null,
                    importOutgoing: parseFloat(row[headerMap.importOutgoing]) || null,
                    importSubstation: parseFloat(row[headerMap.importSubstation]) || null,
                    unit1Counter: parseFloat(row[headerMap.unit1Counter]) || null,
                    unit2Counter: parseFloat(row[headerMap.unit2Counter]) || null,
                };
                batch.set(docRef, docData, { merge: true });
                operationsCount++;
            });

            if (operationsCount === 0) { return showNotification("No valid data rows found to upload.", true); }

            try {
                await batch.commit();
                showNotification(`Successfully uploaded ${operationsCount} records.`, false);
            } catch (error) {
                console.error("Batch upload error:", error);
                showNotification("Upload failed: " + error.message, true);
            }
        }
    </script>
</body>
</html>
