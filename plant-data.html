<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA8UJViacRzajLMJ0lonhrbuuEGO54uOJ4",
    authDomain: "makari-c4270.firebaseapp.com",
    projectId: "makari-c4270",
    storageBucket: "makari-c4270.appspot.com",
    messagingSenderId: "188970014713",
    appId: "1:188970014713:web:980629f953af694e81cf28"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      document.getElementById("user-email").textContent = user.email;
      document.getElementById("user-email").onclick = () => {
        signOut(auth).then(() => location.href = "index.html");
      };
      document.getElementById("entry-date").valueAsDate = new Date();
      loadData(); // Load all data
    } else {
      alert("You must be signed in.");
      window.location.href = "index.html";
    }
  });

  async function submitData() {
    const date = document.getElementById("entry-date").value;
    if (!date) return alert("Please select a date.");

    const data = {
      gen1: parseFloat(document.getElementById("gen1").value) || 0,
      gen2: parseFloat(document.getElementById("gen2").value) || 0,
      gen1h: parseFloat(document.getElementById("gen1h").value) || 0,
      gen2h: parseFloat(document.getElementById("gen2h").value) || 0,
      tx1: parseFloat(document.getElementById("tx1").value) || 0,
      tx2: parseFloat(document.getElementById("tx2").value) || 0,
      stx: parseFloat(document.getElementById("stx").value) || 0,
      ofeeder: parseFloat(document.getElementById("ofeeder").value) || 0,
      obalanch: parseFloat(document.getElementById("obalanch").value) || 0,
      ibalanch: parseFloat(document.getElementById("ibalanch").value) || 0,
      unit: document.getElementById("unit").value,
      user: currentUser.email,
      timestamp: new Date()
    };

    try {
      await setDoc(doc(db, "plantData", date), data); // Save by date
      alert("Data submitted successfully.");
      loadData(); // Refresh display
    } catch (err) {
      console.error("Error writing document: ", err);
      alert("Error saving data.");
    }
  }

  async function loadData() {
    const dataBody = document.getElementById("data-body");
    dataBody.innerHTML = "";

    const q = query(collection(db, "plantData"), orderBy("timestamp"));
    const querySnapshot = await getDocs(q);

    const rows = [];

    querySnapshot.forEach(docSnap => {
      const d = docSnap.data();
      const row = `
        <tr>
          <td>${docSnap.id}</td>
          <td>${d.user}</td>
          <td>${d.gen1}</td>
          <td>${d.gen2}</td>
          <td>${d.gen1h}</td>
          <td>${d.gen2h}</td>
          <td>${d.tx1}</td>
          <td>${d.tx2}</td>
          <td>${d.stx}</td>
          <td>${d.ofeeder}</td>
          <td>${d.obalanch}</td>
          <td>${d.ibalanch}</td>
          <td>${d.unit}</td>
        </tr>
      `;
      rows.push({ date: docSnap.id, html: row });
    });

    // Sort by date ascending (doc ID is date string like '2024-07-25')
    rows.sort((a, b) => a.date.localeCompare(b.date));

    for (const r of rows) {
      dataBody.innerHTML += r.html;
    }

    // Auto-scroll to bottom to show oldest first, with newest at the top
    document.getElementById("data-table").scrollTop = 0;
  }
</script>
