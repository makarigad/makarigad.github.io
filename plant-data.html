<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Data Management - Makari Gad Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover { color: #111827; }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #111827;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-input {
            width: 100%; padding: 2px; font-size: 0.75rem;
            border: 1px solid #d1d5db; border-radius: 0.375rem;
        }
        thead th { padding: 8px 4px !important; white-space: normal !important; }
        #data-body td, #outage-data-body td { font-size: 0.75rem; padding: 4px 3px !important; }
    </style>
</head>
<body class="text-gray-800">
    <div id="header-placeholder"></div>

    <main class="container mx-auto p-4 sm:p-6">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Plant Data Management</h1>
                <p class="text-sm text-gray-500 mt-1">Manage daily readings and monthly PPA data.</p>
            </div>
            <div id="user-info" class="text-right text-sm text-indigo-600 font-semibold cursor-pointer hover:text-indigo-800 mt-3 sm:mt-0" title="Click to logout"></div>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active" data-tab="energy">Daily Energy Readings</button>
                    <button class="tab-button" data-tab="outages">Daily Outages & Losses</button>
                    <button class="tab-button" data-tab="ppa">Monthly PPA Data</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="mt-6">
                <!-- Daily Energy Readings Tab -->
                <div id="tab-energy" class="tab-content active">
                    <div class="flex justify-end mb-4 space-x-2">
                        <button id="download-energy-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 text-sm">Download</button>
                        <button id="upload-energy-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 text-sm">Upload</button>
                        <label for="file-upload-energy" class="sr-only">Upload Energy File</label>
                        <input type="file" id="file-upload-energy" class="hidden" accept=".xlsx, .xls, .csv" title="Upload Energy File" />
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                <!-- Energy Table Headers -->
                                <tr>
                                    <th>English Date</th><th>Nepali Date</th><th>Unit 1 Gen</th><th>Unit 2 Gen</th><th>Unit 1 Trans</th><th>Unit 2 Trans</th><th>Station Trans</th><th>Export Plant</th><th>Export Substation</th><th>Import Outgoing</th><th>Import Substation</th><th>Unit 1 Counter</th><th>Unit 2 Counter</th><th>Operator</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Daily Outages & Losses Tab -->
                <div id="tab-outages" class="tab-content">
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                <!-- Outage Table Headers -->
                                <tr>
                                    <th>English Date</th><th>Nepali Date</th><th>NEA Curtailed (MWh)</th><th>NEA Trip Time (min)</th><th># Trippings</th><th>Total Loss (min)</th><th>U1 Loss (min)</th><th>U2 Loss (min)</th><th>Reason</th><th>Operator</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="outage-data-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Monthly PPA Data Tab -->
                <div id="tab-ppa" class="tab-content">
                    <div class="max-w-3xl mx-auto">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Monthly PPA & Availability Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div><label class="block text-sm font-medium">Year (BS)</label><input type="number" id="ppa-year" placeholder="e.g., 2082" class="mt-1 p-2 w-full border rounded-md"></div>
                            <div><label class="block text-sm font-medium">Month (BS)</label>
                                <select id="ppa-month" class="mt-1 p-2 w-full border rounded-md">
                                    <option value="1">Baisakh</option><option value="2">Jestha</option><option value="3">Ashar</option><option value="4">Shrawan</option><option value="5">Bhadra</option><option value="6">Ashoj</option><option value="7">Kartik</option><option value="8">Mangshir</option><option value="9">Poush</option><option value="10">Magh</option><option value="11">Falgun</option><option value="12">Chaitra</option>
                                </select>
                            </div>
                            <div class="md:pt-6"><button id="load-ppa-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700">Load Data</button></div>
                        </div>
                        <div id="ppa-form-fields" class="space-y-4 border-t pt-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium">Contract Energy (PPA) (kWh)</label><input type="number" step="any" id="ppa-contract-energy" class="mt-1 p-2 w-full border rounded-md"></div>
                                <div><label class="block text-sm font-medium">PPA Days in Month</label><input type="number" id="ppa-days" class="mt-1 p-2 w-full border rounded-md"></div>
                            </div>
                            <h4 class="font-semibold pt-4">Weekly Availability Declaration (kWh)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium">First Week</label><input type="number" step="any" id="ppa-ad-week1" class="mt-1 p-2 w-full border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Second Week</label><input type="number" step="any" id="ppa-ad-week2" class="mt-1 p-2 w-full border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Third Week</label><input type="number" step="any" id="ppa-ad-week3" class="mt-1 p-2 w-full border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Fourth Week</label><input type="number" step="any" id="ppa-ad-week4" class="mt-1 p-2 w-full border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Remaining Days</label><input type="number" step="any" id="ppa-ad-remaining" class="mt-1 p-2 w-full border rounded-md"></div>
                            </div>
                            <div class="flex justify-end pt-4">
                                <button id="save-ppa-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Save Monthly Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { "apiKey": "AIzaSyB9yreNlyZw9DFiuGlwMAecaDkdwn5cxDY", "authDomain": "makari-gad.firebaseapp.com", "projectId": "makari-gad", "storageBucket": "makari-gad.appspot.com", "messagingSenderId": "724611254155", "appId": "1:724611254155:web:79851f67861cee3f90918e" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        const dailyDataPath = "plantData";
        const ppaDataPath = "ppaData";

        // --- Tab Switching Logic ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');
            });
        });

        // --- Auth Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("user-info").textContent = `Logged in as: ${user.email}`;
                document.getElementById("user-info").onclick = () => signOut(auth);
                listenForDailyData();
            } else {
                window.location.href = './index.html';
            }
        });

        // --- Daily Data Logic ---
        let allDailyData = [];
        let dailyUnsubscribe = null;

        function listenForDailyData() {
            if (dailyUnsubscribe) dailyUnsubscribe();
            const q = query(collection(db, dailyDataPath));
            dailyUnsubscribe = onSnapshot(q, (snapshot) => {
                allDailyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDailyData.sort((a, b) => b.id.localeCompare(a.id));
                renderDailyTables();
            });
        }

        function renderDailyTables() {
            const energyBody = document.getElementById('data-body');
            const outageBody = document.getElementById('outage-data-body');
            energyBody.innerHTML = createDailyInputRow('energy');
            outageBody.innerHTML = createDailyInputRow('outage');

            allDailyData.forEach(d => {
                const energyRow = document.createElement('tr');
                energyRow.innerHTML = createDisplayRow(d, 'energy');
                energyBody.appendChild(energyRow);

                const outageRow = document.createElement('tr');
                outageRow.innerHTML = createDisplayRow(d, 'outage');
                outageBody.appendChild(outageRow);
            });
        }
        
        function createDailyInputRow(type) {
            const today = new Date();
            const localToday = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
            const dateString = localToday.toISOString().split('T')[0];
            const operator = currentUser ? currentUser.email : 'N/A';

            if (type === 'energy') {
                return `<tr class="bg-indigo-50">
                    <td><input type="date" id="new-date" value="${dateString}" class="table-input"></td>
                    <td><input type="text" id="new-nepali_date" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit1Gen" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit2Gen" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit1Trans" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit2Trans" class="table-input"></td>
                    <td><input type="number" step="any" id="new-stationTrans" class="table-input"></td>
                    <td><input type="number" step="any" id="new-exportPlant" class="table-input"></td>
                    <td><input type="number" step="any" id="new-exportSubstation" class="table-input"></td>
                    <td><input type="number" step="any" id="new-importOutgoing" class="table-input"></td>
                    <td><input type="number" step="any" id="new-importSubstation" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit1Counter" class="table-input"></td>
                    <td><input type="number" step="any" id="new-unit2Counter" class="table-input"></td>
                    <td class="text-xs truncate" title="${operator}">${operator}</td>
                    <td><button onclick="saveDailyData()" class="bg-indigo-600 text-white text-xs font-bold py-1 px-2 rounded">Add</button></td>
                </tr>`;
            } else { // outage
                 return `<tr class="bg-indigo-50">
                    <td><input type="date" id="new-outage-date" value="${dateString}" class="table-input"></td>
                    <td><input type="text" id="new-outage-nepali_date" class="table-input"></td>
                    <td><input type="number" step="any" id="new-neaCurtailedEnergy" class="table-input"></td>
                    <td><input type="number" step="any" id="new-neaTripTime" class="table-input"></td>
                    <td><input type="number" id="new-tripCount" class="table-input"></td>
                    <td><input type="number" step="any" id="new-lossTimeTotal" class="table-input"></td>
                    <td><input type="number" step="any" id="new-lossTimeUnit1" class="table-input"></td>
                    <td><input type="number" step="any" id="new-lossTimeUnit2" class="table-input"></td>
                    <td><input type="text" id="new-reason" class="table-input"></td>
                    <td class="text-xs truncate" title="${operator}">${operator}</td>
                    <td><button onclick="saveOutageData()" class="bg-indigo-600 text-white text-xs font-bold py-1 px-2 rounded">Add</button></td>
                </tr>`;
            }
        }

        function createDisplayRow(d, type) {
            const operator = d.user || 'N/A';
            if (type === 'energy') {
                return `
                    <td>${d.id}</td><td>${d.nepali_date || ''}</td><td>${d.unit1Gen || ''}</td><td>${d.unit2Gen || ''}</td>
                    <td>${d.unit1Trans || ''}</td><td>${d.unit2Trans || ''}</td><td>${d.stationTrans || ''}</td>
                    <td>${d.exportPlant || ''}</td><td>${d.exportSubstation || ''}</td><td>${d.importOutgoing || ''}</td>
                    <td>${d.importSubstation || ''}</td><td>${d.unit1Counter || ''}</td><td>${d.unit2Counter || ''}</td>
                    <td class="text-xs truncate" title="${operator}">${operator}</td><td>...</td>`;
            } else { // outage
                return `
                    <td>${d.id}</td><td>${d.nepali_date || ''}</td><td>${d.neaCurtailedEnergy || ''}</td>
                    <td>${d.neaTripTime || ''}</td><td>${d.tripCount || ''}</td><td>${d.lossTimeTotal || ''}</td>
                    <td>${d.lossTimeUnit1 || ''}</td><td>${d.lossTimeUnit2 || ''}</td>
                    <td class="text-xs truncate" title="${d.reason || ''}">${d.reason || ''}</td>
                    <td class="text-xs truncate" title="${operator}">${operator}</td><td>...</td>`;
            }
        }
        
        window.saveDailyData = async function() {
            const dateVal = document.getElementById('new-date').value;
            if (!dateVal) { alert("English date is required."); return; }
            const data = {
                user: currentUser.email, uid: currentUser.uid, date: Timestamp.fromDate(new Date(dateVal)),
                nepali_date: document.getElementById('new-nepali_date').value || null,
                unit1Gen: parseFloat(document.getElementById('new-unit1Gen').value) || null,
                unit2Gen: parseFloat(document.getElementById('new-unit2Gen').value) || null,
                unit1Trans: parseFloat(document.getElementById('new-unit1Trans').value) || null,
                unit2Trans: parseFloat(document.getElementById('new-unit2Trans').value) || null,
                stationTrans: parseFloat(document.getElementById('new-stationTrans').value) || null,
                exportPlant: parseFloat(document.getElementById('new-exportPlant').value) || null,
                exportSubstation: parseFloat(document.getElementById('new-exportSubstation').value) || null,
                importOutgoing: parseFloat(document.getElementById('new-importOutgoing').value) || null,
                importSubstation: parseFloat(document.getElementById('new-importSubstation').value) || null,
                unit1Counter: parseFloat(document.getElementById('new-unit1Counter').value) || null,
                unit2Counter: parseFloat(document.getElementById('new-unit2Counter').value) || null,
            };
            await setDoc(doc(db, dailyDataPath, dateVal), data, { merge: true });
            alert('Energy data saved!');
        }
        
        window.saveOutageData = async function() {
            const dateVal = document.getElementById('new-outage-date').value;
            if (!dateVal) { alert("English date is required."); return; }
            const data = {
                user: currentUser.email, uid: currentUser.uid, date: Timestamp.fromDate(new Date(dateVal)),
                nepali_date: document.getElementById('new-outage-nepali_date').value || null,
                neaCurtailedEnergy: parseFloat(document.getElementById('new-neaCurtailedEnergy').value) || null,
                neaTripTime: parseFloat(document.getElementById('new-neaTripTime').value) || null,
                tripCount: parseInt(document.getElementById('new-tripCount').value) || null,
                lossTimeTotal: parseFloat(document.getElementById('new-lossTimeTotal').value) || null,
                lossTimeUnit1: parseFloat(document.getElementById('new-lossTimeUnit1').value) || null,
                lossTimeUnit2: parseFloat(document.getElementById('new-lossTimeUnit2').value) || null,
                reason: document.getElementById('new-reason').value || null,
            };
            await setDoc(doc(db, dailyDataPath, dateVal), data, { merge: true });
            alert('Outage data saved!');
        }

        // --- Monthly PPA Data Logic ---
        const loadPpaBtn = document.getElementById('load-ppa-btn');
        const savePpaBtn = document.getElementById('save-ppa-btn');

        async function loadPpaData() {
            const year = document.getElementById('ppa-year').value;
            const month = String(document.getElementById('ppa-month').value).padStart(2, '0');
            if (!year || !month) { alert("Please select a year and month."); return; }

            const docId = `${year}-${month}`;
            const docRef = doc(db, ppaDataPath, docId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('ppa-contract-energy').value = data.contractEnergy || '';
                document.getElementById('ppa-days').value = data.ppaDays || '';
                document.getElementById('ppa-ad-week1').value = data.adWeek1 || '';
                document.getElementById('ppa-ad-week2').value = data.adWeek2 || '';
                document.getElementById('ppa-ad-week3').value = data.adWeek3 || '';
                document.getElementById('ppa-ad-week4').value = data.adWeek4 || '';
                document.getElementById('ppa-ad-remaining').value = data.adRemaining || '';
            } else {
                alert('No data found for this month. You can enter new data and save it.');
                // Clear form
                document.getElementById('ppa-form-fields').querySelectorAll('input').forEach(i => i.value = '');
            }
        }

        async function savePpaData() {
            const year = document.getElementById('ppa-year').value;
            const month = String(document.getElementById('ppa-month').value).padStart(2, '0');
            if (!year || !month) { alert("Please select a year and month."); return; }
            
            const docId = `${year}-${month}`;
            const data = {
                contractEnergy: parseFloat(document.getElementById('ppa-contract-energy').value) || null,
                ppaDays: parseInt(document.getElementById('ppa-days').value) || null,
                adWeek1: parseFloat(document.getElementById('ppa-ad-week1').value) || null,
                adWeek2: parseFloat(document.getElementById('ppa-ad-week2').value) || null,
                adWeek3: parseFloat(document.getElementById('ppa-ad-week3').value) || null,
                adWeek4: parseFloat(document.getElementById('ppa-ad-week4').value) || null,
                adRemaining: parseFloat(document.getElementById('ppa-ad-remaining').value) || null,
            };

            await setDoc(doc(db, ppaDataPath, docId), data);
            alert('Monthly PPA data saved!');
        }

        loadPpaBtn.addEventListener('click', loadPpaData);
        savePpaBtn.addEventListener('click', savePpaData);

    </script>
</body>
</html>
