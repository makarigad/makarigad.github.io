<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Data - Makari Gad Project</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 10px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #user-info {
      cursor: pointer;
      color: blue;
      font-weight: bold;
    }
    form label {
      display: inline-block;
      width: 140px;
      margin-top: 10px;
    }
    form input, form select {
      width: 150px;
      padding: 5px;
      margin-top: 10px;
    }
    form button {
      margin-top: 20px;
      padding: 8px 16px;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Plant Daily Meter Readings</h1>
    <div id="user-info" title="Click to logout"></div>
  </header>

  <main>
    <form id="data-form">
      <label for="entry-date">Date:</label>
      <input type="date" id="entry-date" required /><br />

      <label for="gen1">Gen Unit 1 (MWh):</label>
      <input type="number" id="gen1" step="0.01" /><br />

      <label for="gen2">Gen Unit 2 (MWh):</label>
      <input type="number" id="gen2" step="0.01" /><br />

      <label for="gen1h">Gen Unit 1 Hours:</label>
      <input type="number" id="gen1h" step="0.01" /><br />

      <label for="gen2h">Gen Unit 2 Hours:</label>
      <input type="number" id="gen2h" step="0.01" /><br />

      <label for="tx1">Transformer 1 (MWh):</label>
      <input type="number" id="tx1" step="0.01" /><br />

      <label for="tx2">Transformer 2 (MWh):</label>
      <input type="number" id="tx2" step="0.01" /><br />

      <label for="stx">Station Transformer (MWh):</label>
      <input type="number" id="stx" step="0.01" /><br />

      <label for="ofeeder">Outgoing Feeder (MWh):</label>
      <input type="number" id="ofeeder" step="0.01" /><br />

      <label for="obalanch">Outgoing Balanch Meter (MWh):</label>
      <input type="number" id="obalanch" step="0.01" /><br />

      <label for="ibalanch">Incoming Balanch Meter (MWh):</label>
      <input type="number" id="ibalanch" step="0.01" /><br />

      <label for="unit">Unit:</label>
      <select id="unit">
        <option value="MWh">MWh</option>
        <option value="kWh">kWh</option>
      </select><br />

      <button type="submit">Submit</button>
    </form>

    <section>
      <h2>Historical Data (All Dates)</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Operator</th>
            <th>Gen1</th>
            <th>Gen2</th>
            <th>Gen1 Hrs</th>
            <th>Gen2 Hrs</th>
            <th>Tx1</th>
            <th>Tx2</th>
            <th>STx</th>
            <th>Out Feeder</th>
            <th>Out Balanch</th>
            <th>In Balanch</th>
            <th>Unit</th>
          </tr>
        </thead>
        <tbody id="data-body"></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      query,
      orderBy,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9yreNlyZw9DFiuGlwMAecaDkdwn5cxDY",
      authDomain: "makari-gad.firebaseapp.com",
      projectId: "makari-gad",
      storageBucket: "makari-gad.appspot.com",
      messagingSenderId: "724611254155",
      appId: "1:724611254155:web:79851f67861cee3f90918e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // Run after DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("data-form");
      const userInfo = document.getElementById("user-info");
      const entryDate = document.getElementById("entry-date");

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          // Not logged in, redirect to login page
          window.location.href = "index.html";
        } else {
          currentUser = user;
          userInfo.textContent = `Logged in as: ${user.email} (click to logout)`;
          entryDate.valueAsDate = new Date();

          userInfo.onclick = () => {
            signOut(auth).then(() => {
              window.location.href = "index.html";
            });
          };

          loadData();
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const dateVal = entryDate.value;
        if (!dateVal) {
          alert("Please select a date.");
          return;
        }

        // Prepare data object from inputs (parseFloat or 0 if empty)
        const data = {
          gen1: parseFloat(document.getElementById("gen1").value) || 0,
          gen2: parseFloat(document.getElementById("gen2").value) || 0,
          gen1h: parseFloat(document.getElementById("gen1h").value) || 0,
          gen2h: parseFloat(document.getElementById("gen2h").value) || 0,
          tx1: parseFloat(document.getElementById("tx1").value) || 0,
          tx2: parseFloat(document.getElementById("tx2").value) || 0,
          stx: parseFloat(document.getElementById("stx").value) || 0,
          ofeeder: parseFloat(document.getElementById("ofeeder").value) || 0,
          obalanch: parseFloat(document.getElementById("obalanch").value) || 0,
          ibalanch: parseFloat(document.getElementById("ibalanch").value) || 0,
          unit: document.getElementById("unit").value || "MWh",
          user: currentUser.email,
          timestamp: Timestamp.fromDate(new Date())
        };

        try {
          // Save document with ID as date string (YYYY-MM-DD)
          await setDoc(doc(db, "plantData", dateVal), data);
          alert("Data saved successfully!");
          loadData();
          form.reset();
          entryDate.valueAsDate = new Date();
        } catch (error) {
          alert("Error saving data: " + error.message);
          console.error(error);
        }
      });

      async function loadData() {
        const dataBody = document.getElementById("data-body");
        dataBody.innerHTML = "";

        const q = query(collection(db, "plantData"), orderBy("timestamp"));
        const querySnapshot = await getDocs(q);

        // Create array of rows with doc ID as date for sorting
        const rows = [];

        querySnapshot.forEach((docSnap) => {
          const d = docSnap.data();
          rows.push({
            date: docSnap.id,
            html: `
              <tr>
                <td>${docSnap.id}</td>
                <td>${d.user}</td>
                <td>${d.gen1}</td>
                <td>${d.gen2}</td>
                <td>${d.gen1h}</td>
                <td>${d.gen2h}</td>
                <td>${d.tx1}</td>
                <td>${d.tx2}</td>
                <td>${d.stx}</td>
                <td>${d.ofeeder}</td>
                <td>${d.obalanch}</td>
                <td>${d.ibalanch}</td>
                <td>${d.unit}</td>
              </tr>
            `
          });
        });

        // Sort by date ascending (YYYY-MM-DD string)
        rows.sort((a, b) => a.date.localeCompare(b.date));

        for (const r of rows) {
          dataBody.innerHTML += r.html;
        }
      }
    });
  </script>
</body>
</html>
